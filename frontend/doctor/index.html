<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç”Ÿå„€è¡¨æ¿ - æ™ºæ…§é†«ç™‚ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script>
        // å‚™ç”¨ Markdown è§£æå™¨
        function simpleMarkdownParser(text) {
            return text
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^\*\*(.*?)\*\*$/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.*)$/gim, '<p>$1</p>')
                .replace(/<p><\/p>/g, '')
                .replace(/<p><h/g, '<h')
                .replace(/<\/h([2-6])><\/p>/g, '</h$1>');
        }
    </script>
    <style>
        .main-view { height: calc(100vh - 68px); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .sidebar-item { cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .sidebar-item.active { background-color: #eef2ff; border-right: 4px solid #4f46e5; }
        .appointment-card { cursor: pointer; transition: border-color 0.2s ease-in-out; }
        .appointment-card.active { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* å°ˆæ¥­é†«å¸«ä»‹é¢è¨­è¨ˆ */
        
        /* ç°¡æ½”çš„ç—…æ‚£å¡ç‰‡ */
        .patient-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            transition: border-color 0.2s ease;
        }
        .patient-card:hover {
            border-color: #3b82f6;
        }
        .patient-card.selected {
            background: #f8fafc;
            border-color: #3b82f6;
            border-width: 2px;
        }
        
        /* å°ˆæ¥­çš„ AI æ‘˜è¦å€åŸŸ - å¢åŠ æ¯”ä¾‹ */
        .ai-summary-container {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
        
        .ai-summary-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            font-weight: 600;
            color: #374151;
        }
        
        .summary-textarea {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            font-size: 14px;
        }
        .summary-textarea:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        
        #summary-content:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
        }
        
        #summary-content:focus:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
        }
        
        /* æ”¹å–„æ‘˜è¦å¯è®€æ€§ - çµæ§‹åŒ–é–±è®€ */
        #summary-content {
            line-height: 1.8;
            font-size: 15px;
            color: #374151;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            text-align: left;
            word-spacing: 0.05em;
        }
        
        /* æ®µè½æ¨£å¼ */
        #summary-content p {
            margin: 16px 0;
            text-indent: 0;
            line-height: 1.7;
        }
        
        #summary-content p:first-child {
            margin-top: 0;
        }
        
        #summary-content p:last-child {
            margin-bottom: 0;
        }
        
        /* æ¨™é¡Œæ¨£å¼ - çµæ§‹åŒ– */
        #summary-content h2 {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin: 24px 0 16px 0;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 8px;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #summary-content h3 {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin: 20px 0 12px 0;
            padding-left: 12px;
            border-left: 4px solid #e5e7eb;
        }
        
        /* æ¢åˆ—å¼å…§å®¹çš„å„ªåŒ– */
        #summary-content ul {
            margin: 16px 0;
            padding-left: 24px;
        }
        
        #summary-content li {
            margin: 8px 0;
            line-height: 1.6;
            position: relative;
        }
        
        #summary-content li::marker {
            color: #3b82f6;
        }
        
        #summary-content strong {
            color: #1f2937;
            font-weight: 600;
        }
        
        /* æ®µè½é–“è·å„ªåŒ– */
        #summary-content > *  * {
            margin-top: 16px;
        }
        
        /* ç‰¹æ®Šå…§å®¹æ¨£å¼ */
        #summary-content blockquote {
            margin: 16px 0;
            padding: 12px 16px;
            background-color: #f8fafc;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            font-style: italic;
        }
        
        /* é‡é»æ¨™è¨˜ */
        #summary-content mark {
            background-color: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* ç°¡æ½”çš„æŒ‰éˆ•æ¨£å¼ */
        .btn-primary {
            background: #3b82f6;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            border: 1px solid #10b981;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            border: 1px solid #f59e0b;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: 500;
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        
        /* ç°¡æ½”çš„ SOAP æ¨¡æ…‹æ¡† */
        .soap-section {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            background: #ffffff;
        }
        .soap-subjective {
            border-left: 3px solid #3b82f6;
        }
        .soap-objective {
            border-left: 3px solid #10b981;
        }
        .soap-assessment {
            border-left: 3px solid #f59e0b;
        }
        .soap-plan {
            border-left: 3px solid #ef4444;
        }
        
        /* ç°¡æ½”çš„ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .review-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* ç§»é™¤èŠ±è£¡èƒ¡å“¨çš„æ•ˆæœ */
        .highlight-important {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
        }
        
        /* ç§»é™¤å‹•ç•«æ•ˆæœ */
        .fade-in, .slide-in {
            animation: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <template id="auth-template">
        <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                <div id="login-view">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">é†«ç”Ÿç™»å…¥</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-username" class="block text-gray-700 text-sm font-bold mb-2">å¸³è™Ÿ</label>
                            <input type="text" id="login-username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">å¯†ç¢¼</label>
                            <input type="password" id="login-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                        <button type="submit" class="btn-primary w-full">ç™»å…¥</button>
                        <p id="login-error-message" class="mt-4 text-center text-red-500 text-xs"></p>
                    </form>
                    <p class="mt-4 text-center text-sm">é‚„æ²’æœ‰å¸³è™Ÿå—ï¼Ÿ <a href="#" id="go-to-register" class="text-indigo-600 hover:underline">é»æ­¤è¨»å†Š</a></p>
                </div>
                <div id="register-view" class="hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">è¨»å†Šé†«ç”Ÿå¸³è™Ÿ</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-name" class="block text-gray-700 text-sm font-bold mb-2">å§“å</label>
                            <input type="text" id="register-name" class="shadow border rounded w-full py-2 px-3" required>
                        </div>
                        <div class="mb-4">
                            <label for="register-specialty" class="block text-gray-700 text-sm font-bold mb-2">ç§‘åˆ¥</label>
                            <input type="text" id="register-specialty" placeholder="ä¾‹å¦‚: å¿ƒè‡Ÿå…§ç§‘" class="shadow border rounded w-full py-2 px-3" required>
                        </div>
                        <hr class="my-4">
                        <div class="mb-4">
                            <label for="register-username" class="block text-gray-700 text-sm font-bold mb-2">è¨­å®šå¸³è™Ÿ</label>
                            <input type="text" id="register-username" class="shadow border rounded w-full py-2 px-3" required>
                        </div>
                        <div class="mb-4">
                            <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2">è¨­å®šå¯†ç¢¼</label>
                            <input type="password" id="register-password" class="shadow border rounded w-full py-2 px-3" required>
                        </div>
                        <button type="submit" class="btn-primary w-full">è¨»å†Š</button>
                        <p id="register-message" class="mt-4 text-center text-xs"></p>
                    </form>
                    <p class="mt-4 text-center text-sm">å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ <a href="#" id="go-to-login" class="text-indigo-600 hover:underline">è¿”å›ç™»å…¥</a></p>
                </div>
            </div>
        </div>
    </template>

    <div id="auth-container"></div>

    <div id="main-app-view" class="hidden">
        <header class="bg-white shadow-md border-b">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-indigo-600">é†«ç”Ÿå„€è¡¨æ¿</h1>
                    <span class="text-sm text-gray-500">æ™ºæ…§é†«ç™‚è³‡è¨Šç³»çµ±</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="doctor-name-display" class="text-gray-700 font-medium"></span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md text-sm transition-colors">ç™»å‡º</button>
                </div>
            </nav>
        </header>
        
        <div class="main-view">
            <div id="main-content-area" class="w-full custom-scrollbar overflow-y-auto">
                <main id="chart-view" class="h-full flex flex-col">
                    <!-- ç—…æ‚£è³‡è¨Šæ¨™é¡Œåˆ— -->
                    <div class="bg-white border-b p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg">
                                <span id="patient-avatar">å¨</span>
                            </div>
                    <div>
                                <h2 id="chart-patient-name" class="text-xl font-bold text-gray-800"></h2>
                                <p id="chart-patient-info" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                        <div class="flex items-center space-x-4">
                            <span class="review-status status-pending">å¾…å¯©æ ¸</span>
                            <div class="flex space-x-2">
                                <button id="prev-patient-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm" title="ä¸Šä¸€ä½ç—…æ‚£">
                                    â† ä¸Šä¸€ä½
                                </button>
                                <button id="next-patient-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm" title="ä¸‹ä¸€ä½ç—…æ‚£">
                                    ä¸‹ä¸€ä½ â†’
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <button id="add-appointment-for-patient-btn" class="btn-primary text-sm">æ–°å¢é ç´„</button>
                                <button id="show-walk-in-modal-btn" class="btn-success text-sm">ç¾å ´æ›è™Ÿ</button>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
                    <div class="flex-1 flex">
                        <!-- å·¦å´ï¼šç—…æ‚£è¨˜éŒ„å’Œäº’å‹• -->
                        <div class="w-1/4 border-r bg-white">
                            <!-- æœ¬æ¬¡çœ‹è¨ºè¨˜éŒ„ -->
                            <div class="border-b p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-semibold text-gray-800 text-sm">æœ¬æ¬¡çœ‹è¨º</h3>
                                    <button id="view-all-appointments-btn" class="text-xs text-blue-600 hover:text-blue-800">æŸ¥çœ‹æ‰€æœ‰è¨˜éŒ„</button>
                        </div>
                                <div id="consult-pre-fill" class="space-y-2">
                                    <div id="current-appointment" class="text-sm text-gray-600">
                                        <!-- æœ¬æ¬¡çœ‹è¨ºè¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                            </div>
                        </div>
                    </div>

                            <!-- å³æ™‚äº’å‹•å€ - å¢å¤§æ¯”ä¾‹ -->
                            <div class="border-b p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 id="interaction-title" class="font-semibold text-gray-800 text-sm">å³æ™‚äº’å‹•å€</h3>
                                    <button id="start-recording-btn" class="btn-success text-xs">é–‹å§‹éŒ„éŸ³</button>
                        </div>
                                <textarea id="transcript-area" class="w-full h-48 p-3 border rounded text-sm font-mono leading-relaxed" placeholder="é»æ“Šé–‹å§‹éŒ„éŸ³æˆ–æ‰‹å‹•è¼¸å…¥..."></textarea>
                                <button id="generate-summary-btn" class="btn-primary w-full mt-2 text-sm">ç”±é€å­—ç¨¿ç”Ÿæˆæ‘˜è¦</button>
                            </div>
                            
                            <!-- AI è¼”åŠ©æç¤º - ç¸®å°æ¯”ä¾‹ -->
                            <div class="p-3">
                                <h3 class="font-semibold text-gray-800 mb-2 text-sm">AI è¼”åŠ©æç¤º</h3>
                                <div id="ai-assist-area" class="text-xs text-gray-600 bg-gray-50 p-2 rounded h-16 overflow-y-auto">
                                    ç—…æ‚£ç›®å‰æ²’æœ‰è¨˜éŒ„ä»»ä½•æƒ³è¨è«–çš„å•é¡Œã€‚
                            </div>
                        </div>
                    </div>

                        <!-- å³å´ï¼šAI æ‘˜è¦å¯©æ ¸å€åŸŸ -->
                        <div class="w-3/4 bg-white flex flex-col h-full">
                            <!-- æ‘˜è¦æ¨™é¡Œåˆ— -->
                            <div class="border-b p-1 bg-gray-50 flex-shrink-0">
                                <div class="flex items-center justify-between">
                                    <h3 id="summary-title" class="text-lg font-bold text-gray-800">AI å•è¨ºæ‘˜è¦</h3>
                                    <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">é†«å¸«å¯©æ ¸</span>
                        </div>
                            </div>
                            
                            <!-- AI æª¢æ¸¬çµæœé¢æ¿ -->
                            <div id="ai-validation-panel" class="border-b p-2 bg-gradient-to-r from-blue-50 to-indigo-50 flex-shrink-0 hidden">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="font-semibold text-blue-800 text-sm">AI å“è³ªæª¢æ¸¬çµæœ</span>
                                        <span id="validation-score" class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">--</span>
                                    </div>
                                    <button id="hide-validation-panel" class="text-xs text-gray-500 hover:text-gray-700">éš±è—</button>
                                </div>
                                
                                <!-- æª¢æ¸¬çµæœæ‘˜è¦ -->
                                <div id="validation-summary" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2">
                                    <!-- å‹•æ…‹å…§å®¹ -->
                                </div>
                                
                                <!-- é—œéµå•é¡Œæé†’ -->
                                <div id="critical-issues" class="space-y-1">
                                    <!-- å‹•æ…‹å…§å®¹ -->
                                </div>
                            </div>
                            
                            <!-- å¯©æ ¸è¦é» -->
                            <div class="border-b p-1 bg-yellow-50 flex-shrink-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                    <span class="font-semibold text-yellow-800 text-sm">å¯©æ ¸è¦é»</span>
                                </div>
                                <p class="text-xs text-yellow-700">è«‹æª¢æŸ¥ AI ç”Ÿæˆçš„æ‘˜è¦æ˜¯å¦æº–ç¢ºåæ˜ ç—…æ‚£ç‹€æ³ï¼Œå¿…è¦æ™‚å¯æ‰‹å‹•ç·¨è¼¯ã€‚</p>
                            </div>
                            
                            <!-- æ‘˜è¦ç·¨è¼¯å€åŸŸ - å®Œå…¨å¡«æ»¿ç©ºé–“ -->
                            <div class="flex-1 min-h-0 relative">
                                <!-- AI æ™ºèƒ½ç·¨è¼¯å™¨ -->
                                <div id="ai-smart-editor" class="w-full h-full min-h-[502px] p-2 border-0 text-sm font-mono leading-relaxed resize-none bg-white relative overflow-hidden">
                                    <!-- åŸå§‹æ‘˜è¦æ–‡å­—å€åŸŸ -->
                                    <div id="summary-content" class="w-full h-full overflow-y-auto" contenteditable="true" data-placeholder="é»æ“Šå·¦å´ã€Œç”Ÿæˆæ‘˜è¦ã€æŒ‰éˆ•ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥..."></div>
                                    
                                    <!-- AI ä¿®æ”¹å»ºè­°è¦†è“‹å±¤ -->
                                    <div id="ai-suggestions-overlay" class="absolute inset-0 pointer-events-none hidden">
                                        <!-- å‹•æ…‹ç”Ÿæˆçš„ä¿®æ”¹å»ºè­° -->
                                    </div>
                                    
               <!-- AI ä¿®æ”¹é€šçŸ¥ -->
               <div id="ai-modification-notice" class="absolute top-2 right-2 bg-white border border-blue-300 rounded-lg p-4 shadow-xl hidden max-w-md max-h-96 overflow-y-auto">
                   <div class="flex items-start space-x-3">
                       <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                           <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                           </svg>
                       </div>
                       <div class="flex-1">
                           <div class="flex items-center justify-between mb-3">
                               <h4 class="font-bold text-gray-800 text-base">AI éŒ¯èª¤æª¢æ¸¬çµæœ</h4>
                               <button id="hide-ai-notice" class="text-gray-400 hover:text-gray-600">
                                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                   </svg>
                               </button>
                           </div>
                           <div id="modification-details" class="space-y-3 mb-4">
                               <!-- å‹•æ…‹å…§å®¹ -->
                           </div>
                           <div class="flex space-x-2 pt-2 border-t border-gray-200">
                               <button id="accept-all-changes" class="bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-2 rounded flex-1">ç¢ºèªç„¡èª¤</button>
                               <button id="reject-all-changes" class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-2 rounded flex-1">å¿½ç•¥è­¦å‘Š</button>
                           </div>
                       </div>
                   </div>
               </div>
                                </div>
                                
                                <!-- å‚™ç”¨ textarea (éš±è—) -->
                                <textarea id="summary-textarea" class="hidden" placeholder="é»æ“Šå·¦å´ã€Œç”Ÿæˆæ‘˜è¦ã€æŒ‰éˆ•ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥..."></textarea>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰éˆ• - å›ºå®šåœ¨åº•éƒ¨ -->
                            <div class="border-t p-1 bg-gray-50 flex-shrink-0">
                                <div class="flex space-x-2 mb-2">
                                    <button id="validate-summary-btn" class="bg-blue-500 hover:bg-blue-600 text-white flex-1 text-sm py-2 rounded">ğŸ” AI éŒ¯èª¤æª¢æ¸¬</button>
                                    <button id="generate-soap-btn" class="btn-warning flex-1 text-sm py-2">ğŸ“‹ æŸ¥çœ‹åˆ¶å¼åŒ–æ‘˜è¦ (SOAP)</button>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="approve-summary-btn" class="btn-success flex-1 text-sm py-2">âœ“ æ‰¹å‡†ä¸¦ç™¼é€æ‘˜è¦</button>
                                </div>
                                <p class="text-xs text-gray-500 text-center mt-1">
                                    AI æª¢æ¸¬æ‘˜è¦ä¸­çš„å¹»è¦ºå’ŒéŒ¯èª¤ï¼Œæ¨™è¨˜èˆ‡é€å­—ç¨¿ä¸ä¸€è‡´ä¹‹è™•
                                </p>
                            </div>
                        </div>
                    </div>
                </main>
                <div id="welcome-view" class="h-full flex items-center justify-center">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">é†«å¸«å°ˆå±¬å„€è¡¨æ¿</h2>
                        <p class="text-gray-500 text-lg mb-6">è«‹é¸æ“‡ä¸€ä½ç—…æ‚£é–‹å§‹çœ‹è¨º</p>
                        <div class="space-x-4">
                            <button id="add-appointment-btn" class="btn-primary">æ–°å¢é ç´„</button>
                            <button id="show-walk-in-modal-btn" class="btn-success">ç¾å ´æ›è™Ÿ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-container" class="hidden">
        <div id="add-appointment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full modal-overlay opacity-0">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white transform scale-95 modal-container">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">æ–°å¢é ç´„</p>
                    <button class="close-modal-btn cursor-pointer z-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="add-appointment-form">
                    <div class="mb-4">
                        <label for="patient-select" class="block text-sm font-medium text-gray-700">é¸æ“‡ç—…æ‚£</label>
                        <select id="patient-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required></select>
                    </div>
                    <div class="mb-4">
                        <label for="appointment-date" class="block text-sm font-medium text-gray-700">é ç´„æ—¥æœŸèˆ‡æ™‚é–“</label>
                        <input type="datetime-local" id="appointment-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required>
                    </div>
                    <div class="mb-4">
                        <label for="appointment-reason" class="block text-sm font-medium text-gray-700">çœ‹è¨ºåŸå› </label>
                        <textarea id="appointment-reason" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary w-full">ç¢ºèªæ–°å¢</button>
                    <p id="add-appointment-message" class="mt-4 text-center text-sm"></p>
                </form>
            </div>
        </div>

        <!-- çœ‹è¨ºè¨˜éŒ„é¸æ“‡å½ˆçª— -->
        <div id="appointments-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full modal-overlay opacity-0">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white transform scale-95 modal-container">
                <div class="flex justify-between items-center pb-4 border-b">
                    <h2 class="text-xl font-bold text-gray-800">ç—…æ‚£çœ‹è¨ºè¨˜éŒ„</h2>
                    <button class="close-modal-btn cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="mt-4">
                    <div id="appointments-list" class="space-y-3">
                        <!-- çœ‹è¨ºè¨˜éŒ„åˆ—è¡¨å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                    </div>
                    </div>
                    </div>

        <div id="soap-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full modal-overlay opacity-0">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md bg-white transform scale-95 modal-container">
                <div class="flex justify-between items-center pb-4 border-b">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">åˆ¶å¼åŒ–æ‘˜è¦ (SOAP æ ¼å¼)</h2>
                        <p class="text-sm text-gray-500 mt-1">AI ç”Ÿæˆçš„æ¨™æº–é†«ç™‚è¨˜éŒ„æ ¼å¼ï¼Œä¾›é†«å¸«å¯©æ ¸åƒè€ƒ</p>
                    </div>
                    <button class="close-modal-btn cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="space-y-6 mt-6">
                    <div class="soap-section soap-subjective">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">S</div>
                            <h4 class="font-bold text-lg text-blue-800">ä¸»è§€ç—‡ç‹€ (Subjective)</h4>
                        </div>
                        <div id="soap-subjective" class="p-4 bg-white rounded-lg border border-blue-200 min-h-[120px] whitespace-pre-wrap text-gray-700"></div>
                    </div>
                    <div class="soap-section soap-objective">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">O</div>
                            <h4 class="font-bold text-lg text-green-800">å®¢è§€ç™¼ç¾ (Objective)</h4>
                        </div>
                        <div id="soap-objective" class="p-4 bg-white rounded-lg border border-green-200 min-h-[120px] whitespace-pre-wrap text-gray-700"></div>
                    </div>
                    <div class="soap-section soap-assessment">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-8 h-8 bg-yellow-500 text-white rounded-full flex items-center justify-center font-bold">A</div>
                            <h4 class="font-bold text-lg text-yellow-800">è©•ä¼° (Assessment)</h4>
                        </div>
                        <div id="soap-assessment" class="p-4 bg-white rounded-lg border border-yellow-200 min-h-[120px] whitespace-pre-wrap text-gray-700"></div>
                    </div>
                    <div class="soap-section soap-plan">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-bold">P</div>
                            <h4 class="font-bold text-lg text-red-800">è¨ˆç•« (Plan)</h4>
                        </div>
                        <div id="soap-plan" class="p-4 bg-white rounded-lg border border-red-200 min-h-[120px] whitespace-pre-wrap text-gray-700"></div>
                    </div>
                    <!-- è™•æ–¹è³‡è¨Š -->
                    <div class="soap-section">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold">Rx</div>
                            <h4 class="font-bold text-lg text-purple-800">è™•æ–¹ (Prescriptions)</h4>
                        </div>
                        <div id="soap-prescriptions" class="p-4 bg-white rounded-lg border border-purple-200 min-h-[80px] text-gray-700">
                            <div class="text-sm text-gray-500">æ­¤çœ‹è¨ºå°šç„¡è™•æ–¹è³‡æ–™</div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        ğŸ’¡ æ­¤æ ¼å¼ç¬¦åˆæ¨™æº–é†«ç™‚è¨˜éŒ„è¦ç¯„ï¼Œå¯ç›´æ¥ç”¨æ–¼ç—…æ­·å»ºæª”
                    </div>
                    <div class="flex space-x-3">
                        <button id="close-soap-modal-btn" class="btn-primary">é—œé–‰</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="records-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full modal-overlay opacity-0">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white transform scale-95 modal-container">
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <h3 class="text-2xl font-bold">ç—…æ­·ç´€éŒ„: <span id="records-patient-name"></span></h3>
                    <button class="close-modal-btn cursor-pointer z-50">
                       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="records-content" class="space-y-4 max-h-[70vh] custom-scrollbar overflow-y-auto">
                </div>
            </div>
        </div>
        
        <!-- AI é©—è­‰çµæœæ¨¡æ…‹æ¡† -->
        <div id="validation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full modal-overlay opacity-0">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white transform scale-95 modal-container">
                <div class="flex justify-between items-center pb-4 border-b">
                    <h2 class="text-xl font-bold text-gray-800">AI æ‘˜è¦å“è³ªé©—è­‰çµæœ</h2>
                    <button id="close-validation-modal-btn" class="close-modal-btn cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="mt-4">
                    <!-- æ•´é«”è©•åˆ† -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">æ•´é«”å“è³ªè©•åˆ†</h3>
                            <div id="overall-score" class="text-2xl font-bold text-blue-600">--</div>
                        </div>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="score-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é©—è­‰çµæœæ¨™ç±¤ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div id="fact-consistency-card" class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">äº‹å¯¦ä¸€è‡´æ€§</h4>
                            <div id="fact-consistency-count" class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-sm text-gray-500">å•é¡Œæ•¸é‡</div>
                        </div>
                        <div id="highlights-card" class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">é—œéµè³‡è¨Š</h4>
                            <div id="highlights-count" class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-sm text-gray-500">æ¨™è¨˜æ•¸é‡</div>
                        </div>
                        <div id="missing-alerts-card" class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">éºæ¼æé†’</h4>
                            <div id="missing-alerts-count" class="text-2xl font-bold text-yellow-600">0</div>
                            <div class="text-sm text-gray-500">æé†’æ•¸é‡</div>
                        </div>
                        <div id="anomalies-card" class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">ç•°å¸¸æ•¸å€¼</h4>
                            <div id="anomalies-count" class="text-2xl font-bold text-red-600">0</div>
                            <div class="text-sm text-gray-500">ç•°å¸¸æ•¸é‡</div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°çµæœ -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- äº‹å¯¦ä¸€è‡´æ€§å•é¡Œ -->
                        <div class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">äº‹å¯¦ä¸€è‡´æ€§å•é¡Œ</h4>
                            <div id="fact-consistency-details" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- å‹•æ…‹å…§å®¹ -->
                            </div>
                        </div>
                        
                        <!-- é—œéµè³‡è¨Šé«˜äº® -->
                        <div class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">é—œéµè³‡è¨Šæ¨™è¨˜</h4>
                            <div id="highlights-details" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- å‹•æ…‹å…§å®¹ -->
                            </div>
                        </div>
                        
                        <!-- éºæ¼æé†’ -->
                        <div class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">æ½›åœ¨éºæ¼æé†’</h4>
                            <div id="missing-alerts-details" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- å‹•æ…‹å…§å®¹ -->
                            </div>
                        </div>
                        
                        <!-- ç•°å¸¸æ•¸å€¼ -->
                        <div class="bg-white border rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">ç•°å¸¸æ•¸å€¼æ¨™è¨˜</h4>
                            <div id="anomalies-details" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- å‹•æ…‹å…§å®¹ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ”¹å–„å»ºè­° -->
                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-3">AI æ”¹å–„å»ºè­°</h4>
                        <div id="recommendations-list" class="space-y-2">
                            <!-- å‹•æ…‹å…§å®¹ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="walk-in-appointment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full modal-overlay opacity-0">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white transform scale-95 modal-container">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">ç¾å ´æ›è™Ÿ</p>
                    <button class="close-modal-btn cursor-pointer z-50">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <form id="walk-in-appointment-form">
                    <div class="mb-4">
                        <label for="walk-in-patient-select" class="block text-sm font-medium text-gray-700">é¸æ“‡ç—…æ‚£</label>
                        <select id="walk-in-patient-select" name="patient_id" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                            <option value="">è®€å–ä¸­...</option>
                        </select>
                    </div>
                     <div class="mb-4">
                        <label for="walk-in-time" class="block text-sm font-medium text-gray-700">çœ‹è¨ºæ™‚é–“</label>
                        <input type="text" id="walk-in-time" class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md shadow-sm py-2 px-3" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="walk-in-reason" class="block text-sm font-medium text-gray-700">ä¸»è¦äº‹ç”±</label>
                        <input type="text" id="walk-in-reason" name="reason" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2" required>
                    </div>
                    <button id="submit-walk-in-appointment-btn" type="button" class="btn-success mt-6 w-full">
                        å»ºç«‹çœ‹è¨ºç´€éŒ„
                    </button>
                </form>
            </div>
        </div>

    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- åˆå§‹åŒ–é†«å¸«å¯©æ ¸å¢å¼·åŠŸèƒ½ ---
            addReviewEnhancements();
            
            // --- å¸¸æ•¸èˆ‡ç‹€æ…‹è®Šæ•¸ ---
            let baseURL;
            const hostname = window.location.hostname;
    
            if (hostname === "127.0.0.1" || hostname === "localhost") {
                baseURL = "http://127.0.0.1:8080";
            } else {
                baseURL = "https://medical-backend-service-577565742177.asia-east1.run.app";
            }
    
            // --- DOM å…ƒç´ åƒè€ƒ ---
            const authContainer = document.getElementById('auth-container');
            const mainAppView = document.getElementById('main-app-view');
            const chartView = document.getElementById('chart-view');
            const welcomeView = document.getElementById('welcome-view');
            const doctorNameDisplay = document.getElementById('doctor-name-display');
            const logoutButton = document.getElementById('logout-button');
            const sidebarMenu = document.getElementById('sidebar-menu');
            const addAppointmentBtn = document.getElementById('add-appointment-btn');
            const modalContainer = document.getElementById('modal-container');
            const addAppointmentModal = document.getElementById('add-appointment-modal');
            const soapModal = document.getElementById('soap-modal');
            const recordsModal = document.getElementById('records-modal');
            const addAppointmentForm = document.getElementById('add-appointment-form');
            const startRecordingBtn = document.getElementById('start-recording-btn');
            const transcriptArea = document.getElementById('transcript-area');
            const summaryContent = document.getElementById('summary-textarea');
            const generateSummaryBtn = document.getElementById('generate-summary-btn');
            const approveSummaryBtn = document.getElementById('approve-summary-btn');
            const generateSoapBtn = document.getElementById('generate-soap-btn');
            const viewRecordsBtn = document.getElementById('view-records-btn');
         
            // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
            let allPatients = [];
            let allAppointments = [];
            let currentDoctorProfile = null;
            let currentPatientForActions = null;
            let currentAppointmentForActions = null;
            let transcriptCache = {};
            
            // --- éŒ„éŸ³ç‹€æ…‹ ---
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;
            let recordingTimerInterval = null;
            let recordingSeconds = 0;
            let stream = null; 
    
            // --- API è¼”åŠ©å‡½å¼ ---
            async function apiRequest(endpoint, method = 'GET', body = null) {
                const token = localStorage.getItem('authToken');
                const headers = {};
                if (!(body instanceof FormData)) {
                    headers['Content-Type'] = 'application/json';
                }
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const config = { method, headers };
                if (body) {
                    if (endpoint === '/token') {
                        headers['Content-Type'] = 'application/x-www-form-urlencoded';
                        config.body = new URLSearchParams(body);
                    } else if (body instanceof FormData) {
                        config.body = body;
                    } else {
                        config.body = JSON.stringify(body);
                    }
                }
                try {
                    const response = await fetch(`${baseURL}${endpoint}`, config);
                    if (response.status === 401) {
                        console.warn("åµæ¸¬åˆ° 401 æœªæˆæ¬ŠéŒ¯èª¤ï¼Œå°‡è‡ªå‹•ç™»å‡ºã€‚");
                        logout(); 
                        throw new Error("æ‚¨çš„ç™»å…¥å·²é€¾æ™‚æˆ–æ†‘è­‰ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `è«‹æ±‚å¤±æ•— (ç‹€æ…‹ç¢¼: ${response.status})`);
                    }
                    return response.status === 204 ? null : await response.json();
                } catch (error) {
                    console.error(`API éŒ¯èª¤ on ${method} ${endpoint}:`, error);
                    throw error;
                }
            }
    
            // --- å·¥å…·å‡½å¼ ---
            function formatDateTime(dateInput) {
                if (!dateInput) return 'ç„¡';
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return 'ç„¡æ•ˆæ—¥æœŸ';
                
                return date.toLocaleString('zh-TW', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            }
    
            // --- äº’å‹•è¦–çª—ç®¡ç† ---
            function openModal(modalElement) {
                if (!modalElement) return;
                const currentOpenModal = modalContainer.querySelector('.modal-overlay:not(.hidden)');
                if (currentOpenModal) {
                    currentOpenModal.classList.add('hidden');
                }
                modalContainer.classList.remove('hidden');
                modalElement.classList.remove('hidden');
                setTimeout(() => {
                    modalElement.classList.remove('opacity-0');
                    const container = modalElement.querySelector('.modal-container');
                    if (container) container.classList.remove('scale-95');
                }, 10);
            }
    
            function closeModal() {
                const openModalElement = modalContainer.querySelector('.modal-overlay:not(.hidden)');
                if (openModalElement) {
                    openModalElement.classList.add('opacity-0');
                    const container = openModalElement.querySelector('.modal-container');
                    if (container) container.classList.add('scale-95');
                    setTimeout(() => {
                        openModalElement.classList.add('hidden');
                        modalContainer.classList.add('hidden');
                    }, 300);
                }
            }
    
            // --- é†«å¸«å¯©æ ¸å¢å¼·åŠŸèƒ½ ---
            function addReviewEnhancements() {
                // æ·»åŠ æ‘˜è¦å¯©æ ¸ç‹€æ…‹è¿½è¹¤
                let reviewStatus = {
                    isReviewed: false,
                    lastModified: null,
                    aiGenerated: false
                };
                
                // ç›£è½æ‘˜è¦è®ŠåŒ–
                const summaryContent = document.getElementById('summary-textarea');
                if (summaryContent) {
                    summaryContent.addEventListener('input', function() {
                        reviewStatus.isReviewed = true;
                        reviewStatus.lastModified = new Date();
                        updateReviewStatus();
                    });
                }
                
                // æ›´æ–°å¯©æ ¸ç‹€æ…‹é¡¯ç¤º
                function updateReviewStatus() {
                    const statusElement = document.querySelector('.review-status');
                    if (statusElement) {
                        if (reviewStatus.isReviewed) {
                            statusElement.textContent = 'å·²å¯©æ ¸';
                            statusElement.className = 'review-status status-approved';
                        } else {
                            statusElement.textContent = 'å¾…å¯©æ ¸';
                            statusElement.className = 'review-status status-pending';
                        }
                    }
                }
                
                // æ·»åŠ é—œéµå­—é«˜äº®åŠŸèƒ½
                function highlightKeywords(text) {
                    const keywords = ['é«˜è¡€å£“', 'ç³–å°¿ç—…', 'å¿ƒè‡Ÿç—…', 'éæ•', 'è—¥ç‰©', 'ç—‡ç‹€', 'æ²»ç™‚', 'è¿½è¹¤'];
                    let highlightedText = text;
                    keywords.forEach(keyword => {
                        const regex = new RegExp(`(${keyword})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
                    });
                    return highlightedText;
                }
                
                // æ·»åŠ æ‘˜è¦å“è³ªæª¢æŸ¥
                function checkSummaryQuality(summary) {
                    const issues = [];
                    if (summary.length < 50) issues.push('æ‘˜è¦éçŸ­');
                    if (!summary.includes('ç—‡ç‹€') && !summary.includes('è¨ºæ–·')) issues.push('ç¼ºå°‘é—œéµé†«ç™‚è³‡è¨Š');
                    if (summary.length > 1000) issues.push('æ‘˜è¦éé•·');
                    
                    return issues;
                }
                
                // æ·»åŠ å¯©æ ¸æé†’
                function showReviewReminder() {
                    const reminder = document.createElement('div');
                    reminder.className = 'fixed top-4 right-4 bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded shadow-lg z-50';
                    reminder.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-semibold">å¯©æ ¸æé†’</span>
                        </div>
                        <p class="mt-1 text-sm">è«‹æª¢æŸ¥ AI ç”Ÿæˆçš„æ‘˜è¦æ˜¯å¦æº–ç¢ºï¼Œå¿…è¦æ™‚é€²è¡Œç·¨è¼¯ã€‚</p>
                    `;
                    document.body.appendChild(reminder);
                    
                    setTimeout(() => {
                        reminder.remove();
                    }, 5000);
                }
                
                // å°å‡ºåŠŸèƒ½ä¾›å…¶ä»–æ¨¡çµ„ä½¿ç”¨
                window.reviewEnhancements = {
                    updateReviewStatus,
                    highlightKeywords,
                    checkSummaryQuality,
                    showReviewReminder
                };
            }
    
            // --- UI æ¸²æŸ“ ---
            let currentPatientIndex = 0;
            
            function renderPatientSidebar(patients) {
                allPatients = patients;
                currentPatientIndex = 0;
                // ç§»é™¤ç—…æ‚£åˆ—è¡¨æ¸²æŸ“ï¼Œæ”¹ç‚ºç›´æ¥é¡¯ç¤ºç¬¬ä¸€å€‹ç—…æ‚£æˆ–æ­¡è¿é é¢
                if (patients && patients.length > 0) {
                    showChartView(patients[0]);
                    updatePatientNavigation();
                } else {
                    showWelcomeView();
                }
            }
            
            function updatePatientNavigation() {
                const prevBtn = document.getElementById('prev-patient-btn');
                const nextBtn = document.getElementById('next-patient-btn');
                
                if (prevBtn && nextBtn && allPatients) {
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    prevBtn.disabled = currentPatientIndex === 0;
                    nextBtn.disabled = currentPatientIndex === allPatients.length - 1;
                    
                    // æ›´æ–°æŒ‰éˆ•æ¨£å¼
                    if (prevBtn.disabled) {
                        prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    
                    if (nextBtn.disabled) {
                        nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            }
            
            function switchToPatient(direction) {
                if (!allPatients || allPatients.length === 0) return;
                
                if (direction === 'next' && currentPatientIndex < allPatients.length - 1) {
                    currentPatientIndex;
                } else if (direction === 'prev' && currentPatientIndex > 0) {
                    currentPatientIndex--;
                }
                
                showChartView(allPatients[currentPatientIndex]);
                updatePatientNavigation();
            }
            
            // æ‰“é–‹çœ‹è¨ºè¨˜éŒ„å½ˆçª—
            function openAppointmentsModal() {
                const modal = document.getElementById('appointments-modal');
                const appointmentsList = document.getElementById('appointments-list');
                
                if (!currentPatientForActions) return;
                
                // ç²å–ç•¶å‰ç—…æ‚£çš„æ‰€æœ‰çœ‹è¨ºè¨˜éŒ„
                const patientAppointments = allAppointments
                    .filter(appt => appt.patient.id === currentPatientForActions.id)
                    .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date));
                
                // æ¸²æŸ“çœ‹è¨ºè¨˜éŒ„åˆ—è¡¨
                appointmentsList.innerHTML = patientAppointments.map(appt => `
                    <div class="border rounded p-3 hover:bg-gray-50 cursor-pointer" data-appointment-id="${appt.id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-gray-800">${formatDateTime(appt.appointment_date)}</div>
                                <div class="text-sm text-gray-600 mt-1">${appt.reason || 'ç„¡çœ‹è¨ºäº‹ç”±'}</div>
                                ${appt.summary ? `<div class="text-xs text-gray-500 mt-1">å·²æœ‰æ‘˜è¦</div>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <span class="text-xs px-2 py-1 rounded ${appt.appointment_type === 'walk-in' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${appt.appointment_type === 'walk-in' ? 'ç¾å ´æ›è™Ÿ' : 'é ç´„å›è¨º'}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                appointmentsList.querySelectorAll('[data-appointment-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const appointmentId = parseInt(item.dataset.appointmentId);
                        const appointment = patientAppointments.find(appt => appt.id === appointmentId);
                        if (appointment) {
                            currentAppointmentForActions = appointment;
                            updateCurrentAppointmentDisplay();
                            closeModal();
                        }
                    });
                });
                
                openModal(modal);
            }
            
            // æ›´æ–°æœ¬æ¬¡çœ‹è¨ºé¡¯ç¤º
            function updateCurrentAppointmentDisplay() {
                const currentAppointmentDiv = document.getElementById('current-appointment');
                if (currentAppointmentForActions) {
                    const appointment = currentAppointmentForActions;
                    const hasSummary = appointment.summary && appointment.summary.trim() !== '';
                    const hasTasks = appointment.tasks && appointment.tasks.length > 0;
                    const hasTags = appointment.tags && appointment.tags.trim() !== '';
                    
                    currentAppointmentDiv.innerHTML = `
                        <div class="bg-gray-50 p-3 rounded-lg border">
                            <!-- åŸºæœ¬è³‡è¨Š -->
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="font-semibold text-gray-800 text-sm">${formatDateTime(appointment.appointment_date)}</div>
                                    <span class="text-xs px-2 py-1 rounded ${appointment.appointment_type === 'walk-in' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                        ${appointment.appointment_type === 'walk-in' ? 'ç¾å ´æ›è™Ÿ' : 'é ç´„å›è¨º'}
                                    </span>
                                </div>
                                
                                <div class="text-sm text-gray-700">
                                    <span class="font-medium">çœ‹è¨ºäº‹ç”±ï¼š</span>${appointment.reason || 'ç„¡çœ‹è¨ºäº‹ç”±'}
                                </div>
                                
                                ${appointment.doctor ? `
                                <div class="text-sm text-gray-700">
                                    <span class="font-medium">ä¸»æ²»é†«å¸«ï¼š</span>${appointment.doctor.name}
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- çœ‹è¨ºç‹€æ…‹ -->
                            <div class="mt-3 pt-2 border-t border-gray-200">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-600">çœ‹è¨ºç‹€æ…‹</span>
                                    <div class="flex items-center space-x-2">
                                        ${hasSummary ? 
                                            '<span class="text-green-600 font-medium">âœ“ å·²æœ‰æ‘˜è¦</span>' : 
                                            '<span class="text-orange-600 font-medium">â³ å¾…ç”Ÿæˆæ‘˜è¦</span>'
                                        }
                                        ${hasTags ? 
                                            '<span class="text-blue-600 font-medium">ğŸ·ï¸ å·²æ¨™ç±¤</span>' : 
                                            '<span class="text-gray-500">ç„¡æ¨™ç±¤</span>'
                                        }
                                    </div>
                                </div>
                                
                                ${hasTasks ? `
                                <div class="mt-2 text-xs text-gray-600">
                                    <span class="font-medium">ç›¸é—œä»»å‹™ï¼š</span>${appointment.tasks.length} é …
                                </div>
                                ` : ''}
                                
                                ${hasSummary ? `
                                <div class="mt-2 text-xs text-gray-600">
                                    <span class="font-medium">æ‘˜è¦é•·åº¦ï¼š</span>${appointment.summary.length} å­—
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- å¿«é€Ÿæ“ä½œ -->
                            <div class="mt-3 pt-2 border-t border-gray-200">
                                <div class="flex space-x-2">
                                    ${!hasSummary ? `
                                    <button class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200" onclick="document.getElementById('generate-summary-btn').click()">
                                        ç”Ÿæˆæ‘˜è¦
                                    </button>
                                    ` : ''}
                                    ${hasSummary ? `
                                    <button class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200" onclick="document.getElementById('approve-summary-btn').click()">
                                        å¯©æ ¸æ‘˜è¦
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    currentAppointmentDiv.innerHTML = `
                        <div class="bg-gray-50 p-3 rounded-lg border border-dashed">
                            <div class="text-center text-gray-500">
                                <div class="text-sm font-medium mb-1">ç„¡çœ‹è¨ºè¨˜éŒ„</div>
                                <div class="text-xs">è«‹é¸æ“‡æˆ–å»ºç«‹çœ‹è¨ºè¨˜éŒ„</div>
                            </div>
                        </div>
                    `;
                }
            }
    
            async function showChartView(patient) {
                currentPatientForActions = patient;
                transcriptCache = {}; // åˆ‡æ›ç—…æ‚£æ™‚ï¼Œæ¸…ç©ºé€å­—ç¨¿æš«å­˜

                welcomeView.classList.add('hidden');
                chartView.classList.remove('hidden');
                document.getElementById('chart-patient-name').textContent = patient.name;
                document.getElementById('chart-patient-info').textContent = `æ€§åˆ¥: ${patient.gender} | ç”Ÿæ—¥: ${patient.birthDate}`;
                document.getElementById('patient-avatar').textContent = patient.name.charAt(0);
                
                const mostRecentAppointment = allAppointments
                    .filter(appt => appt.patient.id === patient.id)
                    .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date))[0];
                
                currentAppointmentForActions = mostRecentAppointment || null;
                updateCurrentAppointmentDisplay();
                
                const addAppointmentForPatientBtn = document.getElementById('add-appointment-for-patient-btn');
                if (addAppointmentForPatientBtn) {
                    addAppointmentForPatientBtn.onclick = () => {
                        openAddAppointmentModal(patient);
                    };
                }
    
                // renderPrefillInChart(patient); // ç§»é™¤ï¼Œæ”¹ç”¨ updateCurrentAppointmentDisplay
                updateInteractionPanels(currentAppointmentForActions);
    
                const aiAssistArea = document.getElementById('ai-assist-area');
                aiAssistArea.textContent = 'æ­£åœ¨å½™æ•´ç—…æ‚£å•é¡Œ...';
                try {
                    const questionsData = await apiRequest(`/tasks/questions/${patient.id}`);
                    
                    if (questionsData && questionsData.length > 0) {
                        const formattedQuestions = questionsData.map(q => `- ${q.question}`).join('\n');
                        aiAssistArea.textContent = `ç—…æ‚£å¯èƒ½æƒ³è¨è«–ä»¥ä¸‹å•é¡Œï¼š\n\n${formattedQuestions}`;
                    } else {
                        aiAssistArea.textContent = 'ç—…æ‚£ç›®å‰æ²’æœ‰è¨˜éŒ„ä»»ä½•æƒ³è¨è«–çš„å•é¡Œã€‚';
                    }
                } catch (error) {
                    console.error("ç„¡æ³•å–å¾—ç—…æ‚£å•é¡Œåˆ—è¡¨:", error);
                    aiAssistArea.textContent = 'ç„¡æ³•å–å¾—ç—…æ‚£å•é¡Œåˆ—è¡¨ã€‚';
                }
            }
    
            function updateInteractionPanels(appointment) {
                currentAppointmentForActions = appointment;
    
                const interactionTitle = document.getElementById('interaction-title');
                const summaryTitle = document.getElementById('summary-title');
                const startRecordingBtn = document.getElementById('start-recording-btn');
                const approveSummaryBtn = document.getElementById('approve-summary-btn');
                // const prescribeBtn = document.getElementById('prescribe-btn'); // å·²ç§»é™¤
                const transcriptArea = document.getElementById('transcript-area');
                const summaryContent = document.getElementById('summary-textarea');
                const generateSummaryBtn = document.getElementById('generate-summary-btn');
                const generateSoapBtn = document.getElementById('generate-soap-btn');
    
                if (appointment) {
                    const appointmentDateStr = formatDateTime(appointment.appointment_date);
                    if (interactionTitle) interactionTitle.innerHTML = `å³æ™‚äº’å‹•å€ <span class="text-sm font-normal text-gray-500">(${appointmentDateStr})</span>`;
                    if (summaryTitle) summaryTitle.innerHTML = `AI å•è¨ºæ‘˜è¦ <span class="text-sm font-normal text-gray-500">(${appointmentDateStr})</span>`;
                    
                    if (startRecordingBtn) startRecordingBtn.disabled = false;
                    if (approveSummaryBtn) approveSummaryBtn.disabled = false;
                    if (generateSoapBtn) generateSoapBtn.disabled = false;
                    if (generateSummaryBtn) generateSummaryBtn.disabled = false;

                    if (transcriptCache[appointment.id]) {
                        if (transcriptArea) transcriptArea.value = transcriptCache[appointment.id];
                    } else {
                        if (transcriptArea) transcriptArea.value = '';
                    }
                    if (transcriptArea) transcriptArea.placeholder = '(é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹éŒ„éŸ³ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥)';
                    if (summaryContent) summaryContent.textContent = appointment.summary || '';
    
                    // prescribeBtn.onclick = () => { // å·²ç§»é™¤è™•æ–¹åŠŸèƒ½
                    //     prescribeForm.reset();
                    //     document.getElementById('prescribe-patient-id').value = appointment.patient.id;
                    //     document.getElementById('prescribe-appointment-id').value = appointment.id;
                    //     document.getElementById('prescribe-message').textContent = '';
                    //     openModal(prescribeModal);
                    // };
    
                    approveSummaryBtn.onclick = async () => {
                        const summaryText = summaryContent.textContent.trim();
                        if (!summaryText) {
                            alert('æ‘˜è¦å…§å®¹ä¸å¯ç‚ºç©ºï¼');
                            return;
                        }
                        try {
                            await apiRequest(`/appointments/${appointment.id}/summary`, 'POST', { summary: summaryText });
                            alert('æ‘˜è¦å·²æˆåŠŸç™¼é€çµ¦ç—…æ‚£ï¼');
                            refreshData();
                        } catch (error) {
                            alert(`ç™¼é€æ‘˜è¦å¤±æ•—: ${error.message}`);
                        }
                    };
    
                } else {
                    if (interactionTitle) interactionTitle.textContent = 'å³æ™‚äº’å‹•å€';
                    if (summaryTitle) summaryTitle.textContent = 'AI å•è¨ºæ‘˜è¦';
                    
                    if (startRecordingBtn) startRecordingBtn.disabled = true;
                    if (approveSummaryBtn) approveSummaryBtn.disabled = true;
                    if (generateSoapBtn) generateSoapBtn.disabled = true;
                    if (generateSummaryBtn) generateSummaryBtn.disabled = true;
                    if (transcriptArea) {
                    transcriptArea.value = '';
                    transcriptArea.placeholder = '(è«‹å…ˆç‚ºæ­¤ç—…æ‚£æ–°å¢é ç´„)';
                    }
                    if (summaryContent) summaryContent.textContent = '';
                    // prescribeBtn.onclick = null; // å·²ç§»é™¤
                    if (approveSummaryBtn) approveSummaryBtn.onclick = null;
                }
    
                if (startRecordingBtn) startRecordingBtn.onclick = toggleRecording;
                if (viewRecordsBtn) {
                viewRecordsBtn.onclick = () => {
                    if (currentPatientForActions) {
                        openModal(recordsModal);
                        loadAndRenderRecords(currentPatientForActions.id, currentPatientForActions.name);
                    }
                };
                }
            }
    
            function renderPrefillInChart(patient) {
                const container = document.getElementById('consult-pre-fill');
                
                const patientAppointments = allAppointments
                    .filter(appt => appt.patient.id === patient.id)
                    .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date));
    
                if (patientAppointments.length > 0) {
                    container.innerHTML = patientAppointments.map(appt => {
                        const isActive = currentAppointmentForActions && appt.id === currentAppointmentForActions.id;
                        
                        const isWalkIn = appt.appointment_type === 'walk-in';
                        const displayReason = appt.reason || '<span class="text-gray-400">æœªæä¾›</span>';
    
                        let typeTag = '';
                        if (isWalkIn) {
                            typeTag = '<span class="ml-2 text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">ç¾å ´æ›è™Ÿ</span>';
                        } else {
                            typeTag = '<span class="ml-2 text-xs font-medium bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">é ç´„å›è¨º</span>';
                        }
    
                        let html = `<div data-appointment-id="${appt.id}" class="appointment-card relative p-3 border rounded-lg bg-gray-50 space-y-2 ${isActive ? 'active' : ''}">`;
                        html = `<button data-appointment-id="${appt.id}" class="delete-appointment-btn absolute top-2 right-2 bg-red-100 text-red-600 hover:bg-red-200 p-1 rounded-full"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                        html = `<div><strong class="text-gray-700">çœ‹è¨ºæ™‚é–“:</strong><div class="flex items-center pl-2">${formatDateTime(appt.appointment_date)} ${typeTag}</div></div>`;
                        html = `<div><strong class="text-gray-700">çœ‹è¨ºäº‹ç”±:</strong><p class="pl-2">${displayReason}</p></div>`;
    
                        if (appt.tasks && appt.tasks.length > 0) {
                            html = `<div class="pt-2 border-t mt-2">`;
                            appt.tasks.forEach(task => {
                                const description = task.description;
                                const submissionTime = formatDateTime(task.created_at);
                                html = `<div class="text-xs text-gray-500 mb-1">ç—…æ‚£å›å ±æ™‚é–“: ${submissionTime}</div>`;
                                
                                const parts = description.split('|');
                                const symptoms = (parts.find(p => p.includes('[ç—‡ç‹€]:')) || '').replace('[ç—‡ç‹€]:', '').trim();
                                const questions = (parts.find(p => p.includes('[æå•]:')) || '').replace('[æå•]:', '').trim();
                                
                                if (symptoms !== 'ç„¡' && symptoms) html = `<div><strong class="text-gray-600 text-sm">ç—‡ç‹€å›å ±:</strong><p class="pl-2 text-gray-800">${symptoms}</p></div>`;
                                if (questions !== 'ç„¡' && questions) html = `<div><strong class="text-gray-600 text-sm">æƒ³å•é†«ç”Ÿçš„å•é¡Œ:</strong><p class="pl-2 text-gray-800">${questions}</p></div>`;
                            });
                            html = `</div>`;
                        }
                        html = '</div>';
                        return html;
                    }).join('');
    
                    document.querySelectorAll('.appointment-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            if (currentAppointmentForActions) {
                                const currentTranscript = document.getElementById('transcript-area').value;
                                if (currentTranscript.trim() !== '') {
                                    transcriptCache[currentAppointmentForActions.id] = currentTranscript;
                                }
                            }
                            const appointmentId = e.currentTarget.dataset.appointmentId;
                            const selectedAppointment = patientAppointments.find(a => a.id == parseInt(appointmentId, 10));
                            if (selectedAppointment) {
                                document.querySelectorAll('.appointment-card').forEach(c => c.classList.remove('active'));
                                e.currentTarget.classList.add('active');
                                updateInteractionPanels(selectedAppointment);
                            } else {
                                console.error("éŒ¯èª¤ï¼šç„¡æ³•åœ¨ patientAppointments é™£åˆ—ä¸­æ‰¾åˆ° ID ç‚º " + appointmentId + " çš„é ç´„ã€‚");
                            }
                        });
                    });
    
                    document.querySelectorAll('.delete-appointment-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const appointmentId = e.currentTarget.dataset.appointmentId;
                            if (confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤ç­†é ç´„ç´€éŒ„å—ï¼Ÿ')) {
                                try {
                                    await apiRequest(`/appointments/${appointmentId}`, 'DELETE');
                                    refreshData();
                                } catch (error) {
                                    alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
                                }
                            }
                        });     
                    });
    
                } else {
                    container.innerHTML = '<p class="text-gray-400 mt-4">é€™ä½ç—…æ‚£æ²’æœ‰ä»»ä½•é ç´„ç´€éŒ„ã€‚</p>';
                }
            }
    
            async function loadAndRenderRecords(patientId, patientName) {
                const recordsContent = document.getElementById('records-content');
                recordsContent.innerHTML = '<p>æ­£åœ¨è¼‰å…¥ç´€éŒ„...</p>';
                document.getElementById('records-patient-name').textContent = patientName;
                try {
                    const prescriptions = await apiRequest(`/patients/${patientId}/prescriptions`);
                    if (prescriptions && prescriptions.length > 0) {
                        recordsContent.innerHTML = prescriptions.map(p => `
                            <div class="p-4 border rounded-lg bg-gray-50 relative">
                                <p class="text-sm text-gray-500"><strong>é–‹ç«‹æ™‚é–“:</strong> ${formatDateTime(p.created_at)}</p>
                                <p><strong>è—¥å“åç¨±:</strong> ${p.medication_name}</p>
                                <p><strong>åŠ‘é‡:</strong> ${p.dosage}</p>
                                <p><strong>é »ç‡:</strong> ${p.frequency}</p>
                                <button data-prescription-id="${p.id}" data-patient-id="${patientId}" class="delete-prescription-btn absolute top-2 right-2 bg-red-100 text-red-600 hover:bg-red-200 p-1 rounded-full">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        `).join('');
                        document.querySelectorAll('.delete-prescription-btn').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                const { prescriptionId, patientId } = e.currentTarget.dataset;
                                if (window.confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è™•æ–¹ç´€éŒ„å—ï¼Ÿ')) {
                                    try {
                                        await apiRequest(`/prescriptions/${prescriptionId}`, 'DELETE');
                                        loadAndRenderRecords(patientId, patientName);
                                    } catch (error) {
                                        alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
                                    }
                                }
                            });
                        });
                    } else {
                        recordsContent.innerHTML = '<p class="text-gray-500">é€™ä½ç—…æ‚£æ²’æœ‰ä»»ä½•è™•æ–¹ç´€éŒ„ã€‚</p>';
                    }
                } catch (error) {
                    recordsContent.innerHTML = `<p class="text-red-500">è¼‰å…¥å¤±æ•—: ${error.message}</p>`;
                }
            }
    
            function showWelcomeView() {
                chartView.classList.add('hidden');
                chartView.classList.remove('grid');
                welcomeView.classList.remove('hidden');
            }
    
            async function refreshData() {
                try {
                    const [patients, appointments] = await Promise.all([
                        apiRequest('/doctors/me/patients'),
                        apiRequest('/doctors/me/appointments')
                    ]);
                    
                    allPatients = patients;
                    allAppointments = appointments;
                    
                    renderPatientSidebar(patients);
    
                    if (currentPatientForActions) {
                        const updatedPatientProfile = allPatients.find(p => p.id === currentPatientForActions.id);
                        if (updatedPatientProfile) {
                            showChartView(updatedPatientProfile);
                            // ç§»é™¤å´é‚Šæ¬„ç›¸é—œé‚è¼¯ï¼Œå› ç‚ºå·²æ”¹ç‚ºå–®ä¸€ç—…æ‚£å„€è¡¨æ¿
                        } else {
                            currentPatientForActions = null;
                            showWelcomeView();
                        }
                    } else {
                        showWelcomeView();
                    }
                    return { patients, appointments };
                } catch (error) {
                    console.error("åˆ·æ–°è³‡æ–™å¤±æ•—:", error);
                    // åœ¨é€™è£¡å¯ä»¥é¸æ“‡æ€§åœ°ç™»å‡ºæˆ–é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
                }
            }
    
            async function showMainApp() {
                try {
                    const doctorProfile = await apiRequest('/doctors/me');
                    currentDoctorProfile = doctorProfile;
                    authContainer.innerHTML = '';
                    authContainer.classList.add('hidden');
                    mainAppView.classList.remove('hidden');
                    showWelcomeView();
                    doctorNameDisplay.textContent = `ä½ å¥½, ${doctorProfile.name} é†«å¸«`;
                    await refreshData();
                } catch (error) {
                    logout();
                }
            }
    
            function showAuth() {
                const authTemplate = document.getElementById('auth-template');
                authContainer.innerHTML = authTemplate.innerHTML;
                authContainer.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                initializeAuthEventListeners();
            }
    
            function logout() {
                localStorage.removeItem('authToken');
                currentPatientForActions = null;
                transcriptCache = {};
                showAuth();
            }
            
            function initializeAuthEventListeners() {
                const loginView = document.getElementById('login-view');
                const registerView = document.getElementById('register-view');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                const goToRegisterLink = document.getElementById('go-to-register');
                const goToLoginLink = document.getElementById('go-to-login');
                
                goToRegisterLink.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    loginView.classList.add('hidden'); 
                    registerView.classList.remove('hidden'); 
                });
                
                goToLoginLink.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    registerView.classList.add('hidden'); 
                    loginView.classList.remove('hidden'); 
                });

                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const loginErrorMessage = document.getElementById('login-error-message');
                    loginErrorMessage.textContent = 'ç™»å…¥ä¸­...';
                    try {
                        const credentials = { 
                            username: loginForm.querySelector('#login-username').value, 
                            password: loginForm.querySelector('#login-password').value 
                        };
                        const response = await apiRequest('/token', 'POST', credentials);
                        localStorage.setItem('authToken', response.access_token);
                        await showMainApp();
                    } catch (error) {
                        loginErrorMessage.textContent = `éŒ¯èª¤: ${error.message}`;
                    }
                });

                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const registerMessage = document.getElementById('register-message');
                    registerMessage.textContent = 'è¨»å†Šä¸­...';
                    const doctorData = {
                        name: registerForm.querySelector('#register-name').value,
                        specialty: registerForm.querySelector('#register-specialty').value,
                        credentials: {
                            username: registerForm.querySelector('#register-username').value,
                            password: registerForm.querySelector('#register-password').value
                        }
                    };
                    try {
                        await apiRequest('/doctors/', 'POST', doctorData);
                        registerMessage.textContent = `è¨»å†ŠæˆåŠŸï¼è«‹è¿”å›ç™»å…¥ã€‚`;
                        registerMessage.className = 'mt-4 text-center text-green-500';
                        registerForm.reset();
                    } catch (error) {
                        registerMessage.textContent = `éŒ¯èª¤: ${error.message}`;
                        registerMessage.className = 'mt-4 text-center text-red-500';
                    }
                });
            }
    
            function toggleRecording() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }
    
            async function startRecording() {
                if (isRecording) return;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isRecording = true;
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    mediaRecorder.onstop = uploadAndTranscribeAudio;
                    mediaRecorder.start();
                    
                    const btn = document.getElementById('start-recording-btn');
                    btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    btn.classList.add('bg-red-500', 'hover:bg-red-600');
                    recordingSeconds = 0;
                    btn.textContent = `åœæ­¢éŒ„éŸ³ (0s)`;
                    recordingTimerInterval = setInterval(() => {
                        recordingSeconds;
                        btn.textContent = `åœæ­¢éŒ„éŸ³ (${recordingSeconds}s)`;
                    }, 1000);

                    document.getElementById('transcript-area').value = 'éŒ„éŸ³ä¸­...';
                    document.getElementById('summary-textarea').value = '';
                } catch (error) {
                    console.error("ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™:", error);
                    alert("ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨è¨­å®šã€‚");
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    resetRecordingUI();
                }
            }

            function stopRecording() {
                if (!isRecording || !mediaRecorder) return;
                mediaRecorder.stop();
                clearInterval(recordingTimerInterval);
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                const btn = document.getElementById('start-recording-btn');
                btn.textContent = 'èªéŸ³è½‰æ–‡å­—ä¸­...';
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-gray-500');
                btn.disabled = true;
                isRecording = false;
            }
    
            async function uploadAndTranscribeAudio() {
                const transcriptArea = document.getElementById('transcript-area');
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                if (audioBlob.size === 0) {
                    transcriptArea.value = 'è™•ç†å¤±æ•—: æ²’æœ‰éŒ„åˆ°ä»»ä½•è²éŸ³ã€‚';
                    resetRecordingUI();
                    return;
                }
                const formData = new FormData();
                formData.append("file", audioBlob, "recording.webm");
                try {
                    const transcribeResult = await apiRequest('/transcribe', 'POST', formData);
                    transcriptArea.value = transcribeResult.transcript || `è½‰éŒ„å¤±æ•—ï¼šå¾Œç«¯æœªè¿”å›æœ‰æ•ˆçš„æ–‡å­—å…§å®¹ã€‚`;
                } catch (error) {
                    transcriptArea.value = `è™•ç†å¤±æ•—: ${error.message}`;
                } finally {
                    resetRecordingUI();
                }
            }

            document.getElementById('generate-summary-btn').addEventListener('click', async () => {
                const transcriptArea = document.getElementById('transcript-area');
                const summaryContent = document.getElementById('summary-content');
                const transcriptText = transcriptArea.value.trim();
    
                if (!transcriptText) {
                    alert('é€å­—ç¨¿å…§å®¹ä¸å¯ç‚ºç©ºï¼');
                    return;
                }
    
                summaryContent.textContent = 'æ­£åœ¨ç”Ÿæˆæ‘˜è¦...';
                try {
                    const summarizeResult = await apiRequest('/summarize', 'POST', { text: transcriptText });
                    // ä½¿ç”¨ Markdown è§£æå™¨æ¸²æŸ“æ ¼å¼åŒ–çš„æ‘˜è¦
                    try {
                        if (typeof marked !== 'undefined' && marked.parse) {
                            // é…ç½® marked.js ä»¥æ­£ç¢ºè§£æ Markdown
                            const markedOptions = {
                                breaks: true,
                                gfm: true,
                                headerIds: false
                            };
                            summaryContent.innerHTML = marked.parse(summarizeResult.summary, markedOptions);
                        } else {
                            console.warn('Marked.js æœªæ­£ç¢ºè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨è§£æå™¨');
                            summaryContent.innerHTML = simpleMarkdownParser(summarizeResult.summary);
                        }
                    } catch (error) {
                        console.error('Markdown è§£æéŒ¯èª¤:', error);
                        summaryContent.innerHTML = simpleMarkdownParser(summarizeResult.summary);
                    }
                    
                    // å­˜å„²åŸå§‹ Markdown å…§å®¹ä¾› AI ä¿®æ”¹ä½¿ç”¨
                    window.currentSummaryMarkdown = summarizeResult.summary;
                    
                    // é¡¯ç¤ºå¯©æ ¸æé†’
                    if (window.reviewEnhancements) {
                        window.reviewEnhancements.showReviewReminder();
                    }
                } catch (error) {
                    summaryContent.textContent = `ç„¡æ³•ç”Ÿæˆæ‘˜è¦: ${error.message}`;
                }
            });
    
            async function openAddAppointmentModal(preselectedPatient = null) {
                addAppointmentForm.reset();
                document.getElementById('add-appointment-message').textContent = '';
                const patientSelect = document.getElementById('patient-select');
                patientSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
                patientSelect.disabled = false;
    
                openModal(addAppointmentModal);
    
                try {
                    const patients = allPatients.length > 0 ? allPatients : await apiRequest('/doctors/me/patients');
                    if (patients && patients.length > 0) {
                        patientSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç—…æ‚£</option>';
                        patients.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.id;
                            option.textContent = `${p.name} (ID: ${p.id})`;
                            patientSelect.appendChild(option);
                        });
                        if (preselectedPatient) {
                            patientSelect.value = preselectedPatient.id;
                            patientSelect.disabled = true;
                        }
                    } else {
                        patientSelect.innerHTML = '<option value="">æ²’æœ‰å¯é ç´„çš„ç—…æ‚£</option>';
                    }
                } catch (error) {
                    patientSelect.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—</option>`;
                }
            }
    
            addAppointmentBtn.addEventListener('click', () => openAddAppointmentModal());
            
            // ç—…æ‚£åˆ‡æ›æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            document.getElementById('prev-patient-btn').addEventListener('click', () => {
                switchToPatient('prev');
            });
            
            document.getElementById('next-patient-btn').addEventListener('click', () => {
                switchToPatient('next');
            });
            
            // æŸ¥çœ‹æ‰€æœ‰çœ‹è¨ºè¨˜éŒ„æŒ‰éˆ•
            document.getElementById('view-all-appointments-btn').addEventListener('click', () => {
                openAppointmentsModal();
            });
            
            // ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            logoutButton.addEventListener('click', () => {
                if (confirm('æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                    logout();
                }
            });
    
            addAppointmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageEl = document.getElementById('add-appointment-message');
                messageEl.textContent = 'æ–°å¢ä¸­...';
                const appointmentData = {
                    patient_id: parseInt(document.getElementById('patient-select').value),
                    appointment_date: document.getElementById('appointment-date').value,
                    reason: document.getElementById('appointment-reason').value
                };
                try {
                    await apiRequest('/appointments/', 'POST', appointmentData);
                    messageEl.textContent = 'é ç´„å·²æˆåŠŸæ–°å¢ï¼';
                    messageEl.className = 'mt-4 text-center text-green-500';
                    setTimeout(() => {
                        closeModal();
                        refreshData();
                    }, 1500);
                } catch (error) {
                    messageEl.textContent = `éŒ¯èª¤: ${error.message}`;
                    messageEl.className = 'mt-4 text-center text-red-500';
                }
            });
    
            // SOAP æ‘˜è¦ç”ŸæˆåŠŸèƒ½
            generateSoapBtn.addEventListener('click', async () => {
                console.log('SOAP æŒ‰éˆ•è¢«é»æ“Š');
                const transcriptText = transcriptArea.value.trim();
                if (!transcriptText) {
                    alert('è«‹å…ˆè¼¸å…¥é€å­—ç¨¿å…§å®¹');
                    return;
                }
                
                try {
                    generateSoapBtn.textContent = 'ç”Ÿæˆä¸­...';
                    generateSoapBtn.disabled = true;
                    
                    console.log('ç™¼é€ SOAP è«‹æ±‚...');
                    const soapData = await apiRequest('/soap-summary', 'POST', {
                        transcript: transcriptText
                    });
                    
                    console.log('æ”¶åˆ° SOAP å›æ‡‰:', soapData);
                    
                    // é¡¯ç¤º SOAP æ‘˜è¦
                    document.getElementById('soap-subjective').textContent = soapData.subjective || 'ç„¡ä¸»è§€ç—‡ç‹€æè¿°';
                    document.getElementById('soap-objective').textContent = soapData.objective || 'ç„¡å®¢è§€ç™¼ç¾';
                    document.getElementById('soap-assessment').textContent = soapData.assessment || 'ç„¡è©•ä¼°çµæœ';
                    document.getElementById('soap-plan').textContent = soapData.plan || 'ç„¡æ²»ç™‚è¨ˆç•«';
                    
                    // é¡¯ç¤º SOAP æ¨¡æ…‹æ¡†å‰ï¼Œè¼‰å…¥è™•æ–¹
                    await loadAndRenderSoapPrescriptions();
                    openModal(soapModal);
                    
                    console.log('SOAP æ¨¡æ…‹æ¡†æ‡‰è©²å·²é¡¯ç¤º');
                    
                } catch (error) {
                    console.error('SOAP ç”ŸæˆéŒ¯èª¤:', error);
                    alert(`ç”Ÿæˆ SOAP æ‘˜è¦å¤±æ•—: ${error.message}`);
                } finally {
                    generateSoapBtn.textContent = 'æŸ¥çœ‹åˆ¶å¼åŒ–æ‘˜è¦ (SOAP)';
                    generateSoapBtn.disabled = false;
                }
            });
    
            // æ‰¹å‡†æ‘˜è¦åŠŸèƒ½
            approveSummaryBtn.addEventListener('click', async () => {
                const summaryText = summaryContent.textContent.trim();
                if (!summaryText) {
                    alert('è«‹å…ˆè¼¸å…¥æˆ–ç”Ÿæˆæ‘˜è¦å…§å®¹');
                    return;
                }
                
                if (!currentAppointmentForActions) {
                    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹çœ‹è¨ºè¨˜éŒ„');
                    return;
                }
                
                if (confirm('ç¢ºå®šè¦æ‰¹å‡†ä¸¦ç™¼é€æ­¤æ‘˜è¦çµ¦ç—…æ‚£å—ï¼Ÿ')) {
                    try {
                        approveSummaryBtn.disabled = true;
                        approveSummaryBtn.textContent = 'ç™¼é€ä¸­...';
                        
                        // ç™¼é€æ‘˜è¦åˆ°å¾Œç«¯
                        await apiRequest(`/appointments/${currentAppointmentForActions.id}/summary`, 'POST', {
                            summary: summaryText
                        });
                        
                        alert('æ‘˜è¦å·²æˆåŠŸç™¼é€çµ¦ç—…æ‚£ï¼');
                        
                        // æ›´æ–°ç‹€æ…‹ç‚ºå·²å¯©æ ¸
                        const statusElement = document.querySelector('.review-status');
                        if (statusElement) {
                            statusElement.textContent = 'å·²å¯©æ ¸';
                            statusElement.className = 'review-status status-approved';
                        }
                        
                        // æ›´æ–°æœ¬æ¬¡çœ‹è¨ºé¡¯ç¤º
                        await refreshData();
                        
                    } catch (error) {
                        console.error('ç™¼é€æ‘˜è¦å¤±æ•—:', error);
                        alert(`ç™¼é€æ‘˜è¦å¤±æ•—: ${error.message}`);
                    } finally {
                        approveSummaryBtn.disabled = false;
                        approveSummaryBtn.textContent = 'âœ“ æ‰¹å‡†ä¸¦ç™¼é€æ‘˜è¦';
                    }
                }
            });
    
            // AI æ™ºèƒ½ä¿®æ”¹åŠŸèƒ½
            document.getElementById('validate-summary-btn').addEventListener('click', async () => {
                // ä½¿ç”¨å­˜å„²çš„ Markdown å…§å®¹ï¼Œè€Œä¸æ˜¯ textContent
                const summaryText = window.currentSummaryMarkdown || document.getElementById('summary-content').textContent.trim();
                const transcriptText = transcriptArea.value.trim();
                
                if (!summaryText) {
                    alert('è«‹å…ˆè¼¸å…¥æˆ–ç”Ÿæˆæ‘˜è¦å…§å®¹');
                    return;
                }
                
                if (!transcriptText) {
                    alert('è«‹å…ˆè¼¸å…¥é€å­—ç¨¿å…§å®¹');
                    return;
                }
                
                try {
                    const validateBtn = document.getElementById('validate-summary-btn');
                    validateBtn.disabled = true;
                    validateBtn.textContent = 'AI ä¿®æ”¹ä¸­...';
                    
                    // èª¿ç”¨ AI æ™ºèƒ½ä¿®æ”¹ API
                    const modificationResult = await apiRequest('/validation/smart-modify', 'POST', {
                        transcript: transcriptText,
                        summary: summaryText
                    });
                    
                    // é¡¯ç¤º AI ä¿®æ”¹çµæœ
                    displayAIModifications(modificationResult);
                    
                } catch (error) {
                    console.error('AI æ™ºèƒ½ä¿®æ”¹å¤±æ•—:', error);
                    alert(`AI æ™ºèƒ½ä¿®æ”¹å¤±æ•—: ${error.message}`);
                } finally {
                    const validateBtn = document.getElementById('validate-summary-btn');
                    validateBtn.disabled = false;
                    validateBtn.textContent = 'ğŸ¤– AI æ™ºèƒ½ä¿®æ”¹';
                }
            });
            
            // é¡¯ç¤º AI æ™ºèƒ½ä¿®æ”¹çµæœ
            function displayAIModifications(result) {
                const summaryContent = document.getElementById('summary-content');
                const overlay = document.getElementById('ai-suggestions-overlay');
                const notice = document.getElementById('ai-modification-notice');
                const details = document.getElementById('modification-details');
                
                console.log('AI ä¿®æ”¹çµæœ:', result);
                
                // é¡¯ç¤ºéŒ¯èª¤æª¢æ¸¬çµæœ
                details.innerHTML = result.modifications.map((mod, index) => `
                    <div class="border-b border-gray-200 pb-2 mb-2 last:border-b-0">
                        <div class="flex items-start space-x-2">
                            <div class="w-3 h-3 rounded-full ${getErrorColor(mod.severity)} mt-1 flex-shrink-0"></div>
                            <div class="flex-1">
                                <div class="font-semibold text-sm text-red-800">${mod.title || 'éŒ¯èª¤æª¢æ¸¬'}</div>
                                <div class="text-xs text-gray-600 mt-1">${mod.description || 'ç„¡è©³ç´°èªªæ˜'}</div>
                                ${mod.original_text ? `<div class="text-xs text-red-600 mt-1"><strong>æ‘˜è¦ä¸­çš„å…§å®¹ï¼š</strong>"${mod.original_text}"</div>` : ''}
                                ${mod.correct_text ? `<div class="text-xs text-green-600 mt-1"><strong>é€å­—ç¨¿ä¸­çš„å…§å®¹ï¼š</strong>"${mod.correct_text}"</div>` : ''}
                                ${mod.reason ? `<div class="text-xs text-blue-600 mt-1"><strong>éŒ¯èª¤åŸå› ï¼š</strong>${mod.reason}</div>` : ''}
                                <div class="flex items-center space-x-2 mt-2">
                                    <span class="text-xs px-2 py-1 rounded ${getSeverityColor(mod.severity)}">${getSeverityText(mod.severity)}</span>
                                    <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">${getErrorCategoryText(mod.category)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // é¡¯ç¤ºè¦†è“‹å±¤å’Œé€šçŸ¥
                overlay.classList.remove('hidden');
                notice.classList.remove('hidden');
                
                // æ·»åŠ äº‹ä»¶ç›£è½å™¨
                document.getElementById('accept-all-changes').onclick = () => {
                    console.log('é»æ“Šç¢ºèªç„¡èª¤ï¼Œé–‹å§‹æ‡‰ç”¨ä¿®æ”¹ï¼ˆä½¿ç”¨ä¼ºæœå™¨ä¿è­‰çš„ patched_summaryï¼‰');
                    if (result && result.patched_summary) {
                        applyPatchedSummary(result.patched_summary);
                    } else {
                        // å‘å¾Œç›¸å®¹ï¼šè‹¥æ²’æœ‰ patched_summaryï¼Œæ‰é€€å›èˆŠçš„å®¢ç«¯å¥—ç”¨æ–¹å¼
                        applyAIModifications(result.modifications);
                    }
                    hideAIModifications();
                };
                
                document.getElementById('reject-all-changes').onclick = () => {
                    // æ¢å¾©åŸå§‹å…§å®¹ - ä½¿ç”¨ Markdown è§£æå™¨æ¸²æŸ“
                    try {
                        // è™•ç†å¯èƒ½çš„æ›è¡Œç¬¦æ ¼å¼
                        let processedOriginal = result.original_summary;
                        if (result.original_summary.includes('\\n')) {
                            processedOriginal = result.original_summary.replace(/\\n/g, '\n');
                        }
                        
                        if (typeof marked !== 'undefined' && marked.parse) {
                            // é…ç½® marked.js ä»¥æ­£ç¢ºè§£æ Markdown
                            const markedOptions = {
                                breaks: true,
                                gfm: true,
                                headerIds: false
                            };
                            summaryContent.innerHTML = marked.parse(processedOriginal, markedOptions);
                        } else {
                            console.warn('Marked.js æœªæ­£ç¢ºè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨è§£æå™¨');
                            summaryContent.innerHTML = simpleMarkdownParser(processedOriginal);
                        }
                        
                        // æ›´æ–°å­˜å„²çš„ Markdown å…§å®¹
                        window.currentSummaryMarkdown = processedOriginal;
                        
                    } catch (error) {
                        console.error('Markdown è§£æéŒ¯èª¤:', error);
                        summaryContent.innerHTML = simpleMarkdownParser(processedOriginal);
                    }
                    hideAIModifications();
                };
                
                document.getElementById('hide-ai-notice').onclick = hideAIModifications;
            }
            
            function hideAIModifications() {
                document.getElementById('ai-suggestions-overlay').classList.add('hidden');
                document.getElementById('ai-modification-notice').classList.add('hidden');
            }
            
            // ç›´æ¥æ¡ç”¨å¾Œç«¯å›å‚³ä¹‹ patched_summaryï¼ˆä¿ç•™ Markdown çµæ§‹èˆ‡æ›è¡Œï¼‰
            function applyPatchedSummary(markdown) {
                const summaryContent = document.getElementById('summary-content');
                try {
                    // è™•ç†å¯èƒ½çš„æ›è¡Œç¬¦æ ¼å¼
                    let processedMarkdown = markdown;
                    // å¦‚æœæ˜¯å­—é¢ä¸Šçš„ \n å­—ç¬¦ä¸²ï¼Œè½‰æ›ç‚ºå¯¦éš›æ›è¡Œ
                    if (markdown.includes('\\n')) {
                        processedMarkdown = markdown.replace(/\\n/g, '\n');
                    }
                    console.log('åŸå§‹ patched_summary:', markdown);
                    console.log('è™•ç†å¾Œçš„ Markdown:', processedMarkdown);
                    
                    if (typeof marked !== 'undefined' && marked.parse) {
                        // é…ç½® marked.js ä»¥æ­£ç¢ºè§£æ Markdown
                        const markedOptions = {
                            breaks: true,
                            gfm: true,
                            headerIds: false
                        };
                        summaryContent.innerHTML = marked.parse(processedMarkdown, markedOptions);
                        console.log('ä½¿ç”¨ marked.js è§£æ Markdown');
                    } else {
                        console.warn('Marked.js æœªæ­£ç¢ºè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨è§£æå™¨');
                        summaryContent.innerHTML = simpleMarkdownParser(processedMarkdown);
                    }
                    
                    // æ›´æ–°å­˜å„²çš„ Markdown å…§å®¹
                    window.currentSummaryMarkdown = processedMarkdown;
                    
                } catch (error) {
                    console.error('Markdown è§£æéŒ¯èª¤:', error);
                    summaryContent.innerHTML = simpleMarkdownParser(processedMarkdown);
                }
            }
            
            // è‡ªå‹•æ‡‰ç”¨ AI æª¢æ¸¬åˆ°çš„ä¿®æ”¹
            function applyAIModifications(modifications) {
                const summaryContent = document.getElementById('summary-content');
                
                // ç²å–ç•¶å‰çš„ Markdown å…§å®¹ï¼ˆå¾ innerHTML è½‰æ›å›ä¾†ï¼Œæˆ–ä½¿ç”¨å­˜å„²çš„ Markdownï¼‰
                let currentContent = window.currentSummaryMarkdown || summaryContent.textContent;
                
                console.log('åŸå§‹å…§å®¹:', currentContent);
                console.log('æª¢æ¸¬åˆ°çš„ä¿®æ”¹:', modifications);
                
                // æŒ‰ç…§åš´é‡ç¨‹åº¦æ’åºï¼Œå…ˆè™•ç†åš´é‡éŒ¯èª¤
                const sortedModifications = modifications.sort((a, b) => {
                    const severityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1 };
                    return (severityOrder[b.severity] || 0) - (severityOrder[a.severity] || 0);
                });
                
                let modifiedCount = 0;
                let processedContent = currentContent;
                
                // æ‡‰ç”¨æ¯å€‹ä¿®æ”¹
                sortedModifications.forEach((mod, index) => {
                    console.log(`è™•ç†ä¿®æ”¹ ${index + 1}:`, mod);
                    
                    if (mod.type === 'remove' && mod.original_text) {
                        // ç§»é™¤éŒ¯èª¤å…§å®¹
                        if (processedContent.includes(mod.original_text)) {
                            processedContent = processedContent.replace(mod.original_text, '');
                            modifiedCount++;
                            console.log(`ç§»é™¤å…§å®¹: "${mod.original_text}"`);
                        }
                    } else if (mod.type === 'replace' && mod.original_text && mod.correct_text) {
                        // æ›¿æ›éŒ¯èª¤å…§å®¹
                        if (processedContent.includes(mod.original_text)) {
                            processedContent = processedContent.replace(mod.original_text, mod.correct_text);
                            modifiedCount++;
                            console.log(`æ›¿æ›å…§å®¹: "${mod.original_text}" -> "${mod.correct_text}"`);
                        }
                    } else if (mod.type === 'highlight' && mod.original_text) {
                        // é«˜äº®å…§å®¹ï¼ˆåœ¨ Markdown ä¸­ç”¨ ** æ¨™è¨˜ï¼‰
                        if (processedContent.includes(mod.original_text)) {
                            processedContent = processedContent.replace(mod.original_text, `**${mod.original_text}**`);
                            modifiedCount++;
                            console.log(`é«˜äº®å…§å®¹: "${mod.original_text}"`);
                        }
                    }
                });
                
                // ç‚ºé¿å…ç ´å£ Markdown çµæ§‹ï¼Œé€™è£¡ä¸å†åšç©ºç™½èˆ‡æ¨™é»çš„æ¸…ç†/é‡æ’
                processedContent = processedContent;
                
                console.log('ä¿®æ”¹å¾Œçš„ Markdown å…§å®¹:', processedContent);
                
                // æ›´æ–°æ‘˜è¦å…§å®¹ï¼Œä½¿ç”¨ Markdown æ¸²æŸ“
                try {
                    if (typeof marked !== 'undefined' && marked.parse) {
                        summaryContent.innerHTML = marked.parse(processedContent);
                    } else {
                        console.warn('Marked.js æœªæ­£ç¢ºè¼‰å…¥ï¼Œä½¿ç”¨å‚™ç”¨è§£æå™¨');
                        summaryContent.innerHTML = simpleMarkdownParser(processedContent);
                    }
                } catch (error) {
                    console.error('Markdown è§£æéŒ¯èª¤:', error);
                    summaryContent.innerHTML = simpleMarkdownParser(processedContent);
                }
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯å’Œä¿®æ”¹è©³æƒ…
                if (modifiedCount > 0) {
                    let modificationDetails = [];
                    sortedModifications.forEach((mod, index) => {
                        if (mod.type === 'remove' && processedContent.includes(mod.original_text) === false) {
                            modificationDetails.push(`â€¢ ç§»é™¤ï¼š${mod.original_text}`);
                        } else if (mod.type === 'replace' && processedContent.includes(mod.correct_text)) {
                            modificationDetails.push(`â€¢ æ›¿æ›ï¼š${mod.original_text} â†’ ${mod.correct_text}`);
                        } else if (mod.type === 'highlight' && processedContent.includes(`**${mod.original_text}**`)) {
                            modificationDetails.push(`â€¢ é«˜äº®ï¼š${mod.original_text}`);
                        }
                    });
                    
                    const detailText = modificationDetails.length > 0 ? 
                        `\n\nä¿®æ”¹è©³æƒ…ï¼š\n${modificationDetails.join('\n')}` : '';
                    
                    showSuccessMessage(`å·²è‡ªå‹•ä¿®æ­£ ${modifiedCount} å€‹å•é¡Œ${detailText}`);
                } else {
                    showSuccessMessage('æœªç™¼ç¾éœ€è¦ä¿®æ­£çš„å•é¡Œ');
                }
            }
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            function showSuccessMessage(message) {
                const notice = document.getElementById('ai-modification-notice');
                const successDiv = document.createElement('div');
                successDiv.className = 'bg-green-100 border border-green-300 rounded-lg p-3 mb-3';
                successDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-green-800 font-medium">${message}</span>
                    </div>
                `;
                
                // æ’å…¥åˆ°é€šçŸ¥é¢æ¿çš„é ‚éƒ¨
                notice.insertBefore(successDiv, notice.firstChild);
                
                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤æˆåŠŸè¨Šæ¯
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 3000);
            }
            
            function getModificationColor(type) {
                const colors = {
                    'add': 'bg-green-500',
                    'replace': 'bg-yellow-500', 
                    'highlight': 'bg-blue-500',
                    'remove': 'bg-red-500'
                };
                return colors[type] || 'bg-gray-500';
            }
            
            function getPriorityColor(priority) {
                const colors = {
                    'high': 'bg-red-100 text-red-800',
                    'medium': 'bg-yellow-100 text-yellow-800',
                    'low': 'bg-green-100 text-green-800'
                };
                return colors[priority] || 'bg-gray-100 text-gray-800';
            }
            
            function getPriorityText(priority) {
                const texts = {
                    'high': 'é«˜å„ªå…ˆç´š',
                    'medium': 'ä¸­å„ªå…ˆç´š',
                    'low': 'ä½å„ªå…ˆç´š'
                };
                return texts[priority] || 'æœªçŸ¥å„ªå…ˆç´š';
            }
            
            function getCategoryText(category) {
                const texts = {
                    'medical_info': 'é†«ç™‚è³‡è¨Š',
                    'safety': 'å®‰å…¨è€ƒé‡',
                    'clarity': 'æ¸…æ™°åº¦',
                    'completeness': 'å®Œæ•´æ€§'
                };
                return texts[category] || 'ä¸€èˆ¬';
            }
            
            function getErrorColor(severity) {
                const colors = {
                    'critical': 'bg-red-500',
                    'high': 'bg-orange-500',
                    'medium': 'bg-yellow-500',
                    'low': 'bg-blue-500'
                };
                return colors[severity] || 'bg-gray-500';
            }
            
            function getSeverityColor(severity) {
                const colors = {
                    'critical': 'bg-red-100 text-red-800',
                    'high': 'bg-orange-100 text-orange-800',
                    'medium': 'bg-yellow-100 text-yellow-800',
                    'low': 'bg-blue-100 text-blue-800'
                };
                return colors[severity] || 'bg-gray-100 text-gray-800';
            }
            
            function getSeverityText(severity) {
                const texts = {
                    'critical': 'åš´é‡éŒ¯èª¤',
                    'high': 'é«˜é¢¨éšª',
                    'medium': 'ä¸­ç­‰é¢¨éšª',
                    'low': 'ä½é¢¨éšª'
                };
                return texts[severity] || 'æœªçŸ¥é¢¨éšª';
            }
            
            function getErrorCategoryText(category) {
                const texts = {
                    'hallucination': 'å¹»è¦ºå…§å®¹',
                    'fact_error': 'äº‹å¯¦éŒ¯èª¤',
                    'value_error': 'æ•¸å€¼éŒ¯èª¤',
                    'time_error': 'æ™‚é–“éŒ¯èª¤',
                    'diagnosis_error': 'è¨ºæ–·éŒ¯èª¤',
                    'treatment_error': 'æ²»ç™‚éŒ¯èª¤'
                };
                return texts[category] || 'ä¸€èˆ¬éŒ¯èª¤';
            }
            
            // åœ¨æ‘˜è¦å€åŸŸä¸­é¡¯ç¤º AI é©—è­‰çµæœ
            function displayValidationResultsInline(result) {
                const panel = document.getElementById('ai-validation-panel');
                const scoreElement = document.getElementById('validation-score');
                const summaryElement = document.getElementById('validation-summary');
                const issuesElement = document.getElementById('critical-issues');
                
                // æ›´æ–°è©•åˆ†
                scoreElement.textContent = `${result.overall_score}/100`;
                scoreElement.className = `text-xs px-2 py-1 rounded-full ${
                    result.overall_score >= 85 ? 'bg-green-100 text-green-800' :
                    result.overall_score >= 70 ? 'bg-yellow-100 text-yellow-800' :
                    'bg-red-100 text-red-800'
                }`;
                
                // æ›´æ–°æª¢æ¸¬çµæœæ‘˜è¦
                summaryElement.innerHTML = `
                    <div class="text-center">
                        <div class="text-lg font-bold ${result.fact_consistency.length > 0 ? 'text-red-600' : 'text-green-600'}">${result.fact_consistency.length}</div>
                        <div class="text-xs text-gray-600">ä¸€è‡´æ€§å•é¡Œ</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold text-blue-600">${result.highlights.length}</div>
                        <div class="text-xs text-gray-600">é—œéµè³‡è¨Š</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold ${result.missing_alerts.length > 0 ? 'text-yellow-600' : 'text-green-600'}">${result.missing_alerts.length}</div>
                        <div class="text-xs text-gray-600">éºæ¼æé†’</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold ${result.anomalies.length > 0 ? 'text-red-600' : 'text-green-600'}">${result.anomalies.length}</div>
                        <div class="text-xs text-gray-600">ç•°å¸¸æ•¸å€¼</div>
                    </div>
                `;
                
                // é¡¯ç¤ºé—œéµå•é¡Œ
                const criticalIssues = [];
                
                // äº‹å¯¦ä¸€è‡´æ€§å•é¡Œ
                result.fact_consistency.forEach(issue => {
                    if (issue.level === 'error' || issue.level === 'critical') {
                        criticalIssues.push({
                            type: 'ä¸€è‡´æ€§å•é¡Œ',
                            message: issue.message,
                            color: 'red'
                        });
                    }
                });
                
                // éºæ¼æé†’
                result.missing_alerts.forEach(alert => {
                    if (alert.level === 'error' || alert.level === 'critical') {
                        criticalIssues.push({
                            type: 'éºæ¼è³‡è¨Š',
                            message: alert.message,
                            color: 'yellow'
                        });
                    }
                });
                
                // ç•°å¸¸æ•¸å€¼
                result.anomalies.forEach(anomaly => {
                    if (anomaly.severity === 'high') {
                        criticalIssues.push({
                            type: 'ç•°å¸¸æ•¸å€¼',
                            message: `æ•¸å€¼ ${anomaly.value} è¶…å‡ºæ­£å¸¸ç¯„åœ ${anomaly.normal_range}`,
                            color: 'red'
                        });
                    }
                });
                
                // é¡¯ç¤ºé—œéµå•é¡Œ
                if (criticalIssues.length > 0) {
                    issuesElement.innerHTML = criticalIssues.map(issue => `
                        <div class="flex items-start space-x-2 p-2 bg-${issue.color}-50 border border-${issue.color}-200 rounded">
                            <div class="w-2 h-2 bg-${issue.color}-500 rounded-full mt-1 flex-shrink-0"></div>
                            <div class="flex-1">
                                <div class="text-xs font-medium text-${issue.color}-800">${issue.type}</div>
                                <div class="text-xs text-${issue.color}-700">${issue.message}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    issuesElement.innerHTML = `
                        <div class="text-center py-2 text-green-600 text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            æ‘˜è¦å“è³ªè‰¯å¥½ï¼Œç„¡é—œéµå•é¡Œ
                        </div>
                    `;
                }
                
                // é¡¯ç¤ºé¢æ¿
                panel.classList.remove('hidden');
                
                // æ·»åŠ éš±è—æŒ‰éˆ•äº‹ä»¶
                document.getElementById('hide-validation-panel').onclick = () => {
                    panel.classList.add('hidden');
                };
            }
            
            // é¡¯ç¤º AI é©—è­‰çµæœ
            function displayValidationResults(result) {
                const modal = document.getElementById('validation-modal');
                
                // æ›´æ–°æ•´é«”è©•åˆ†
                document.getElementById('overall-score').textContent = result.overall_score;
                document.getElementById('score-bar').style.width = `${result.overall_score}%`;
                
                // æ›´æ–°å„é …çµ±è¨ˆ
                document.getElementById('fact-consistency-count').textContent = result.fact_consistency.length;
                document.getElementById('highlights-count').textContent = result.highlights.length;
                document.getElementById('missing-alerts-count').textContent = result.missing_alerts.length;
                document.getElementById('anomalies-count').textContent = result.anomalies.length;
                
                // é¡¯ç¤ºäº‹å¯¦ä¸€è‡´æ€§å•é¡Œ
                const factDetails = document.getElementById('fact-consistency-details');
                factDetails.innerHTML = result.fact_consistency.map(item => `
                    <div class="p-3 bg-red-50 border border-red-200 rounded">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-red-800">${item.category}</span>
                            <span class="text-xs px-2 py-1 rounded ${getLevelColor(item.level)}">${item.level}</span>
                        </div>
                        <p class="text-sm text-red-700 mt-1">${item.message}</p>
                        ${item.suggestion ? `<p class="text-xs text-red-600 mt-1">å»ºè­°: ${item.suggestion}</p>` : ''}
                    </div>
                `).join('');
                
                // é¡¯ç¤ºé—œéµè³‡è¨Šæ¨™è¨˜
                const highlightsDetails = document.getElementById('highlights-details');
                highlightsDetails.innerHTML = result.highlights.map(item => `
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-blue-800">${item.category}</span>
                            <span class="text-xs px-2 py-1 rounded ${getImportanceColor(item.importance)}">${item.importance}</span>
                        </div>
                        <p class="text-sm text-blue-700 mt-1">${item.text}</p>
                        <p class="text-xs text-blue-600 mt-1">ä¿¡å¿ƒåº¦: ${(item.confidence * 100).toFixed(1)}%</p>
                    </div>
                `).join('');
                
                // é¡¯ç¤ºéºæ¼æé†’
                const missingDetails = document.getElementById('missing-alerts-details');
                missingDetails.innerHTML = result.missing_alerts.map(item => `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-yellow-800">${item.category}</span>
                            <span class="text-xs px-2 py-1 rounded ${getLevelColor(item.level)}">${item.level}</span>
                        </div>
                        <p class="text-sm text-yellow-700 mt-1">${item.message}</p>
                        ${item.suggestion ? `<p class="text-xs text-yellow-600 mt-1">å»ºè­°: ${item.suggestion}</p>` : ''}
                    </div>
                `).join('');
                
                // é¡¯ç¤ºç•°å¸¸æ•¸å€¼
                const anomaliesDetails = document.getElementById('anomalies-details');
                anomaliesDetails.innerHTML = result.anomalies.map(item => `
                    <div class="p-3 bg-red-50 border border-red-200 rounded">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-red-800">ç•°å¸¸æ•¸å€¼</span>
                            <span class="text-xs px-2 py-1 rounded ${getSeverityColor(item.severity)}">${item.severity}</span>
                        </div>
                        <p class="text-sm text-red-700 mt-1">æ•¸å€¼: ${item.value}</p>
                        <p class="text-xs text-red-600 mt-1">æ­£å¸¸ç¯„åœ: ${item.normal_range}</p>
                        <p class="text-xs text-red-600 mt-1">å»ºè­°: ${item.suggestion}</p>
                    </div>
                `).join('');
                
                // é¡¯ç¤ºæ”¹å–„å»ºè­°
                const recommendationsList = document.getElementById('recommendations-list');
                recommendationsList.innerHTML = result.recommendations.map(rec => `
                    <div class="p-3 bg-white border border-blue-300 rounded">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-blue-800">${rec.title}</span>
                            <span class="text-xs px-2 py-1 rounded ${getPriorityColor(rec.priority)}">${rec.priority}</span>
                        </div>
                        <p class="text-sm text-blue-700 mb-2">${rec.description}</p>
                        <div class="text-xs text-blue-600">
                            <strong>å»ºè­°è¡Œå‹•:</strong>
                            <ul class="list-disc list-inside mt-1">
                                ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('');
                
                // é¡¯ç¤ºæ¨¡æ…‹æ¡†
                openModal(modal);
            }
            
            // è¼”åŠ©å‡½æ•¸
            function getLevelColor(level) {
                const colors = {
                    'info': 'bg-blue-100 text-blue-800',
                    'warning': 'bg-yellow-100 text-yellow-800',
                    'error': 'bg-red-100 text-red-800',
                    'critical': 'bg-red-200 text-red-900'
                };
                return colors[level] || 'bg-gray-100 text-gray-800';
            }
            
            function getImportanceColor(importance) {
                const colors = {
                    'low': 'bg-gray-100 text-gray-800',
                    'medium': 'bg-yellow-100 text-yellow-800',
                    'high': 'bg-orange-100 text-orange-800',
                    'critical': 'bg-red-100 text-red-800'
                };
                return colors[importance] || 'bg-gray-100 text-gray-800';
            }
            
            function getSeverityColor(severity) {
                const colors = {
                    'low': 'bg-yellow-100 text-yellow-800',
                    'medium': 'bg-orange-100 text-orange-800',
                    'high': 'bg-red-100 text-red-800'
                };
                return colors[severity] || 'bg-gray-100 text-gray-800';
            }
            
            function getPriorityColor(priority) {
                const colors = {
                    'low': 'bg-gray-100 text-gray-800',
                    'medium': 'bg-yellow-100 text-yellow-800',
                    'high': 'bg-orange-100 text-orange-800',
                    'critical': 'bg-red-100 text-red-800'
                };
                return colors[priority] || 'bg-gray-100 text-gray-800';
            }
    
            modalContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay') || e.target.closest('.close-modal-btn')) {
                    closeModal();
                }
            });
            
            // SOAP æ¨¡æ…‹æ¡†é—œé–‰åŠŸèƒ½
            document.getElementById('close-soap-modal-btn').addEventListener('click', () => {
                console.log('é—œé–‰ SOAP æ¨¡æ…‹æ¡†');
                closeModal(soapModal);
            });
    
            const walkInModal = document.getElementById('walk-in-appointment-modal');
            const showWalkInBtn = document.getElementById('show-walk-in-modal-btn');
            const submitWalkInBtn = document.getElementById('submit-walk-in-appointment-btn');
            const walkInPatientSelect = document.getElementById('walk-in-patient-select');
            const walkInForm = document.getElementById('walk-in-appointment-form');
            const walkInTimeInput = document.getElementById('walk-in-time');
    
            showWalkInBtn.addEventListener('click', async () => {
                walkInForm.reset();
                walkInTimeInput.value = formatDateTime(new Date());
                
                walkInPatientSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
                openModal(walkInModal);
                try {
                    // âœ¨ ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ /patients/ ç«¯é»ç²å–æ‰€æœ‰ç—…æ‚£
                    const patients = await apiRequest('/patients/');
                    walkInPatientSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç—…æ‚£</option>';
                    patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.id;
                        option.textContent = `${patient.name} (ID: ${patient.id})`;
                        walkInPatientSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("è¼‰å…¥ç—…æ‚£åˆ—è¡¨å¤±æ•—:", error);
                    walkInPatientSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                }
            });
    
            submitWalkInBtn.addEventListener('click', async () => {
                const patientId = parseInt(walkInPatientSelect.value);
                const reason = document.getElementById('walk-in-reason').value;
    
                if (!patientId || !reason) {
                    alert('è«‹é¸æ“‡ç—…æ‚£ä¸¦å¡«å¯«ä¸»è¦äº‹ç”±ã€‚');
                    return;
                }
                
                const walkInData = { patient_id: patientId, reason: reason };
    
                try {
                    await apiRequest('/appointments/walk-in', 'POST', walkInData);
                    alert('ç¾å ´æ›è™ŸæˆåŠŸï¼');
                    closeModal();
                    await refreshData();
                    
                    // è‡ªå‹•é¸ä¸­å‰›å‰›æ›è™Ÿçš„ç—…æ‚£
                    const newPatient = allPatients.find(p => p.id === patientId);
                    if (newPatient) {
                        showChartView(newPatient);
                    }

                } catch (error) {
                    console.error('ç¾å ´æ›è™Ÿå¤±æ•—:', error);
                    alert(`ç¾å ´æ›è™Ÿå¤±æ•—: ${error.message}`);
                }
            });
    
    
            function init() {
                if (localStorage.getItem('authToken')) {
                    showMainApp();
                } else {
                    showAuth();
                }
                
            }
            
            function resetRecordingUI() {
                const btn = document.getElementById('start-recording-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'é–‹å§‹éŒ„éŸ³';
                    btn.classList.remove('bg-gray-500', 'bg-red-500', 'hover:bg-red-600');
                    btn.classList.add('bg-green-500', 'hover:bg-green-600');
                }
            }

            async function loadAndRenderSoapPrescriptions() {
                const container = document.getElementById('soap-prescriptions');
                if (!currentPatientForActions) {
                    container.innerHTML = '<div class="text-sm text-gray-500">å°šæœªé¸æ“‡ç—…æ‚£</div>';
                    return;
                }
                container.innerHTML = '<div class="text-sm text-gray-500">è¼‰å…¥è™•æ–¹ä¸­...</div>';
                try {
                    const prescriptions = await apiRequest(`/patients/${currentPatientForActions.id}/prescriptions`);
                    if (!prescriptions || prescriptions.length === 0) {
                        container.innerHTML = '<div class="text-sm text-gray-500">æ­¤ç—…æ‚£ç›®å‰æ²’æœ‰è™•æ–¹è³‡æ–™</div>';
                        return;
                    }
                    
                    // ä½¿ç”¨ DOM æ“ä½œé¿å…å­—ä¸²æ‹¼æ¥å•é¡Œ
                    container.innerHTML = '';
                    const table = document.createElement('table');
                    table.className = 'w-full text-sm';
                    
                    // å»ºç«‹è¡¨é ­
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'text-left text-gray-600';
                    
                    const headers = ['è—¥å“åç¨±', 'åŠ‘é‡', 'é »ç‡', 'è—¥ç¢¼', 'é–‹ç«‹æ™‚é–“'];
                    headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.className = 'py-2 pr-2';
                        th.textContent = headerText;
                        headerRow.appendChild(th);
                    });
                    
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    
                    // å»ºç«‹è¡¨é«”
                    const tbody = document.createElement('tbody');
                    prescriptions.forEach(rx => {
                        const row = document.createElement('tr');
                        row.className = 'border-t';
                        
                        const cells = [
                            rx.medication_name || '-',
                            rx.dosage || '-',
                            rx.frequency || '-',
                            rx.medication_code || '-',
                            formatDateTime(rx.created_at || rx.prescribed_on)
                        ];
                        
                        cells.forEach((cellText, index) => {
                            const td = document.createElement('td');
                            td.className = index === 0 ? 'py-2 pr-2 text-gray-800' : 
                                         index === 4 ? 'py-2 text-gray-500' : 'py-2 pr-2 text-gray-700';
                            td.textContent = cellText;
                            row.appendChild(td);
                        });
                        
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(tbody);
                    container.appendChild(table);
                    
                } catch (e) {
                    console.error('è¼‰å…¥è™•æ–¹å¤±æ•—', e);
                    container.innerHTML = `<div class="text-sm text-red-600">è¼‰å…¥è™•æ–¹å¤±æ•—: ${e.message}</div>`;
                }
            }

            init();
        });
    </script>
    </body>
    </html>